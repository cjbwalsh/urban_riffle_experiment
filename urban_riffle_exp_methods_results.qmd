---
title: "Urban riffle experiment: methods, results"
author: "Christopher J Walsh, J. Angus Webb, et al."
format: html
editor: visual
editor_options: 
  chunk_output_type: inline
bibliography: references.bib
---

```{r}
#| echo: false
#| message: false
#| error: false

# load misc data files from OSF
library(osfr); library(dplyr); library(rgeos); library(sf); library(prettymapr)
if(!"data" %in% dir())  dir.create("data")
gpkg_files <- dir(here::here("data"))[grep("gpkg",dir(here::here("data")))]
all_gpkgs <- c("Australia_GDA94_GCS.gpkg","Victoria_GDA94_GCS.gpkg")
gpkg_files <- all_gpkgs[!all_gpkgs %in% gpkg_files]
if (length(gpkg_files) > 0) {
  spatial_files <- osf_retrieve_node("3um4v") %>% osf_ls_files(n_max = 20)
  osf_download(spatial_files[spatial_files$name %in% gpkg_files,], path = "data")
}

dat_file <- 
"~/uomShare/wergStaff/ChrisW/git-data/urban_riffle_experiment/data_for_model.xlsx"
sites <- data.frame(readxl::read_excel(dat_file, sheet = "sites"), 
                    stringsAsFactors = FALSE)
sites <- sf::st_as_sf(sites, coords = c("mgae","mgan"))
```

## Introduction

Working methods and results for paper on the urban riffle experiment.

## Methods

### Study area and experimental design

The experiment was a before-after-control-impact (BACI) study with the 'impact' being the construction of rock riffles in degraded urban streams. We selected sites on nine streams draining separate catchments in the eastern suburbs of Melbourne, Victoria, Australia (@fig-experiment_map), and randomly allocated six as 'impact' sites in which riffles were constructed, and three as 'control' sites. All sites were sampled twice in the year before riffle construction, and twice in each of two 'after' periods: *a1* in the first year and *a2*, 5 and 6 years after riffle construction. We inferred effects of the riffles from the interactions between the before-after and control-impact effects: short-term effects using the before-*a1* difference and long-term effects using the before-*a2* difference.

The streams' catchments all included conventionally drained [sensu @burns2012] urban land with effective imperviousness (estimated in 2004, with little urban growth since the commencement of the study) ranging from 4 to 32% (@fig-experiment_map). We further assessed if the effects of riffles differed with degree of urbanization by assessing the interactions between before-after (both *a1* and *a2*), control-impact and effective imperviousness.

We surveyed all 9 reaches before the study, to estimate likely tractive force at peak flows, and selected a segment of each reach as the location for a riffle given the bed profile (and the segment to be sampled for macroinvertebrates). We consulted with an engineer who designed and supervised the construction of riffles in these segments on six streams in November 1996. The riffles were 9-22-long, with slopes of ___, and made of rocks with diameters 15-40 cm, deemed the minimum size for riffle stability, and typical of river management practice in Melbourne's urban streams. The sampled segments were left unchanged in the three control streams, but it is noteworthy that in the mid 2000s, management authorities had constructed similar rock riffles on the sampled segments of two of the control reaches.  


```{r}
#| label: fig-experiment_map
#| echo: false
#| fig-width: 5
#| fig-height: 6.5
#| warning: false
#| message: false
#| fig-cap: "Map of experimental sites (6 sites in which riffles were constructed and 3 control sites) and their catchments. The extent of impervious coverage (in 2004, gray basemap), piped sections of streams (dark grey stream lines), and the percentage effective imperviousness of each catchment indicate the range of urban impacts among the sites."

source("https://tools.thewerg.unimelb.edu.au/documents/mwstr/mwstr_functions.R")
source("https://tools.thewerg.unimelb.edu.au/data/mwbugs/bugDatabaseFunctions.R")

#Streams for creating a map sqlQuery is a function I wrote, stored in mwstr_functions.R, loaded above
streams <- sqlQuery("SELECT * FROM streams WHERE sampleable = 1;", "mwstr")
pipes <- sqlQuery("SELECT * FROM streams WHERE type = 'pipe';", "mwstr")
sites$reach <- substr(sites$sitecode, 1, nchar(sites$sitecode) - 1)
cats <- sqlQuery(paste0("SELECT * FROM cats WHERE reach IN ('",
                        paste(sites$reach, collapse = "', '"), "');"), "mwstr")
coast <- sqlQuery("SELECT * FROM coast;", "mwstr")
# impervious coverage raster
ia <- terra::rast("~/uomShare/wergStaff/ChrisW/git-data/mwstr/mwstr_v12_corrections/rasters_v13/r_imp_2004.tif")
# crop to area to be plotted (placing a 10 km buffer around the cats polygons)
ia <- terra::crop(ia, terra::ext(sf::st_buffer(cats,1e4)))
victoria <- sf::st_read("data/Victoria_GDA94_GCS.gpkg", quiet = TRUE)
australia <- sf::st_read("data/Australia_GDA94_GCS.gpkg", quiet = TRUE)
#Colour sites by experimental treatment (see: https://colorbrewer2.org/)
sites$col <- 
  RColorBrewer::brewer.pal(3,"Dark2")[match(sites$exp_treatment == "riffle",0:1)]

layout(matrix(c(1,2,1,3,1,4,1,5),4,2,byrow = TRUE), 
       widths = c(10,2.5), heights = c(8,8,4,4))
par(mar = c(0,0,0,0))
plot(cats$geometry, pch = 21, border = "white")
terra::plot(ia, col = gray(0.5), legend = FALSE, axes = FALSE, add = TRUE)
plot(cats$geometry, border = sites$col[match(cats$reach,sites$reach)], 
     col = scales::alpha(sites$col[match(cats$reach,sites$reach)],0.25),
     lwd = 2, add = TRUE)
plot(streams$geometry, col = "dodgerblue", add = TRUE)
plot(pipes$geometry, col = gray(0.25), add = TRUE)
x <- rgeos::polygonsLabel(as_Spatial(cats), 
                     paste0(round(100*sites$ai[match(cats$site,sites$site)]),"%"),
                     font = 2)
plot(coast$geometry, lwd = 2, add = TRUE)
plot(sites$geom, pch = 21, bg = sites$col, add = TRUE) # so that the sites are on top
rng <- par('usr')
prettymapr::addscalebar(pos = "bottomright", label.cex = 1, )
box()
rngPoly <- st_sfc(st_polygon(list(rbind(rng[c(1,3)], rng[c(1,4)], rng[c(2,4)], 
                                 rng[c(2,3)],rng[c(1,3)]))))
rngPoly <- st_sf(a = 1, geom = rngPoly)
# Legends
plot.new()
legend("center", pch = c(21,21,15), pt.cex = c(1,1,2), 
       pt.bg = c(RColorBrewer::brewer.pal(3,"Dark2"),NA),
       col = c("black","black",gray(0.5)),
       legend = c("Control","Riffle","Impervious"),bty = "n")
box()
plot.new()
legend("center", lty = 1, col = c("dodgerblue",gray(0.25)),
       legend = c("Stream","Piped stream"),bty = "n")
box()
# Location maps
st_crs(rngPoly) <- 28355
rngPoly <- rngPoly %>% st_transform(4283)
par(mai = c(0.028,0.028,0.028,0.028) * 0)
plot(australia$geom)
plot(victoria$geom, col = "white", add = TRUE)
polygon(c(142.9651,146.5656,146.5656,142.9651),c(-39.1122,-39.1122,-36.4374,-36.4374), col = scales::alpha(gray(0.5),0.5))
plot(rngPoly$geom, col = "black", add = TRUE)
title(main = "Australia", adj = 0, 
      font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
bounds <- st_sfc(st_point(c(143.5,-36.5)), st_point(c(146.5,-39.1)),crs=4283)
plot(bounds, col = "white")
plot(victoria$geom, add = TRUE)
rng_vic <- par("usr")
plot(rngPoly$geom, col = scales::alpha(gray(0.5),0.5), add = TRUE)
title(main = "Central Victoria ", 
      adj = 1, font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
```

### Riffle design and construction

### Macroinvertebrate assemblage sampling and identification

Data were collected at the nine sites on six occasions; twice prior to the installation of riffles (Nov. 1995, Feb 1996), and four times after riffle installation (Nov. 1996, Feb. 1997, Dec. 1999, Feb. 2001). On each occasion, 4 macroinvertebrate sub-samples at each site were collected using a 0.04 m2 suction sample (Boulton 1985).

Four replicate sample units taken along the reach of each site on each date comprise a sample.

Identified to lowest practicable taxonomic level (Details)

### Environmental variable determination

Depth, velocity, substrate(?), catchment effective imperviousness

### Statistical models

We modelled the total count of taxon *j* in each sample unit, *i*, ($Y_{i,j}$) as a negative binomial distribution (given the highly skewed distributions of taxon counts) and the count of taxon *j*, ($c_{i,j}$), in a subsample of sample unit *i* as a binomial distribution given the subsample proportion $s_{i,j}$ and $Y_{i,j}$. Thus:

$$
\begin{align}
&Y_{i,j} \sim \textrm{Neg. Binomial}(\mu_{i,j}, \phi_{j}) \\
\\
&c_{i,j} \sim \textrm{Binomial}(s_{i,j}, Y_{i,j})
\end{align}
$$ {#eq-taxon_count_likelihood}

where $\mu_{i,j}$ = the mean total count of taxon *j* in sample unit *i*, and $\phi_j$ = the dispersion parameter of the negative binomial distribution for taxon *j*.

We modelled $\mu_{i,j}$ as a linear model of 6 fixed predictors and four 4 random predictors, thus:

$$
\begin{align}
\mu_{(i,j)} \sim \ &\alpha_j + \beta\_ba_{j} * BA_i + \beta\_ci_{j} * CI_i  + \beta\_baci_{j} * BA_i * CI_i + \beta\_i_j * I_i \ +\\
& \beta\_bacii_{j} * BA_i * CI_i * I_i + \beta\_i_j * I_i + \beta\_{s}_j * S_i \ +\\
& \theta_{1(i,si)} + \theta_{2(i,sa)} + \theta_{3(i,t)}+ \epsilon_{(i,j)}
\end{align}
$$ {#eq-exp_linear_model}

where $\alpha_j$ is the model intercept for taxon *j*, $\beta\_ba_{j}$ is the before-after effect (*BA*, a categorical variable with values before, first year after, *a1*, and fifth/sixth year after, *a2* ), $\beta\_ci_{j}$ is the control-impact effect (*CI*), $\beta\_baci_{j}$ is the interaction of the *BA* and *CI* effects, and $\beta\_bacii_{j}$ is the interaction of the *BA*, *CI* and *I* effects. $\beta\_i_{j}$ is the the effect of catchment effective imperviousness (*I*), $\beta\_s_{j}$ is the the effect of season (*S*: autumn = 0, spring = 1). The $\theta$ and $\epsilon$ parameters model the error structure of the dataset. $\theta_{1(i,si)}$ models variation among samples within each site, indexed by *si*. $\theta_{2(i,sa)}$ models variation among the four sample units within each sample, indexed by *sa*. $\theta_{3(i,t)}$ models variation among samples within each sampling campaign, indexed by *t*. $\epsilon_{(i,j)}$ models random variation among all sample units.

All $\beta$ parameters were formulated as random effects drawn from community-level hyper-distributions with the mean parameters specified as diffuse normal distributions (mean 0, standard deviation 5) and the parameters for each species drawn from a multivariate normal distribution with a variance-covariance matrix that describes the residual associations among species.

<!--# There are full sets of L and U samples for trips 1-4. Could be worth exploring effects over the three sections, but for now, let's just stick with M samples.  -->
