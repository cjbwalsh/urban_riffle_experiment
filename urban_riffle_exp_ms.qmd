---
title: "Constructed rock riffles increase habitat heterogeneity but not biodiversity in streams constrained by catchment urban impacts (draft)"
author: "Christopher J Walsh, J. Angus Webb, et al."
format: docx
editor: visual
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r}
#| echo: false
#| message: false
#| error: false
#| include: false

source("misc_functions.R") # for ct function

# load misc data files from OSF
# library(osfr); library(dplyr); library(rgeos); library(sf); library(prettymapr)

## Packages required for code to run
requiredPackages <- c("osfr","dplyr","readxl","rio","flextable","ftExtra",
                      "sf","prettymapr","terra","RColorBrewer","scales","glue")
lapply(requiredPackages, require, character.only = TRUE, quietly = TRUE)

## Check if there is a 'data' directory. If not make one
if(!"data" %in% dir()){dir.create("data")}
## While in review, the 3 large data files are in a private OSF repository
## They can be downloaded to the data directory using this view-only link
## https://osf.io/cms84/?view_only=256efadc4a124bcb96c6483226ef3a23
## When the repository is public, the following will allow automatic download
# ## The following checks for large data files, and if absent downloads them 
# ## from the OSF repository to the data directory
# if(!"wq_data_compiled.xlsx" %in% dir("data")){
# wq_files <- osf_retrieve_node("cms84") %>% osf_ls_files()
# osf_download(wq_files, path = "data")
# }

# Load observed data as in S3
dat_file <- "data/urban_riffle_experiment_data_for_model.xlsx"
sites <- data.frame(readxl::read_excel(dat_file, sheet = "sites"), 
                    stringsAsFactors = FALSE)
sites <- sf::st_as_sf(sites, coords = c("mgae","mgan"))
samples <- data.frame(readxl::read_excel(dat_file, sheet = "samples"), 
                      stringsAsFactors = FALSE)
biota <- data.frame(readxl::read_excel(dat_file, sheet = "biota"), 
                    stringsAsFactors = FALSE)
taxa <- data.frame(readxl::read_excel(dat_file, sheet = "taxa"), 
                   stringsAsFactors = FALSE)
higher_taxa <- data.frame(readxl::read_excel(dat_file, sheet = "higher_taxa"), 
                   stringsAsFactors = FALSE)

samples$seg <- substr(samples$old_samplecode,nchar(samples$old_samplecode)-1,
                      nchar(samples$old_samplecode)-1)
# The dataset contains samples from the segments upstream and downstream of the 
# riffle (putative or real) in each site for trip 1-4 (out of 6).  Given the 
# small effects in the 'riffle' segments (M), theu U and L segments were not 
# included in the analysis.
samples <- samples[samples$seg == "M",]
# Reduce biota table to match reduced samples table
biota <- biota[biota$smpcode %in% samples$smpcode,]
# Convert long-form biota table into a wide taxon-by-sample table of counts 
# in subsamples
biota_ct <- as.data.frame(ct(biota$smpcode, biota$shortcode, biota$count))
biota_ct <- biota_ct[match(samples$smpcode,row.names(biota_ct)),]
# Create a table of the same dimensions as biota_ct, with the subsample proportion
# for each observation (for coarsepick specimens, subsample ppn = 1)
ss_ct <- biota_ct
for(i in 1:nrow(samples)){
  ss_ct[i,] <- samples$subsample_perc[i]/100
}
for(i in which(biota$coarsepick == 1)){
  ss_ct[row.names(ss_ct) == biota$smpcode[i], biota$shortcode[i]] <- 1
}

# Assemble random predictors (site_no, sample_no, t)
sites <- sites[order(sites$exp_treatment,sites$ai),]
sites$site_no <- 1:nrow(sites)
samples$site_no <- sites$site_no[match(samples$sitecode,sites$sitecode)]
samples$sample <- substr(samples$old_samplecode,1,nchar(samples$old_samplecode)-1)
sample_nos <- data.frame(sample = unique(samples$sample))
sample_nos$sample_no <- 1:nrow(sample_nos)
samples$sample_no <- sample_nos$sample_no[match(samples$sample, sample_nos$sample)]
samples$t <- as.numeric(substr(samples$old_samplecode, 1,1))

# Assemble fixed predictors (a1,a2, ci, ba1ci, ba2ci, i, ba1cii, ba2cii, spring) into a matrix, u
samples$ba <- as.numeric(as.numeric(substr(samples$old_samplecode,1,1)) %in% c(3,4)) 
samples$ba[as.numeric(as.numeric(substr(samples$old_samplecode,1,1))) %in% c(5,6)] <- 2
samples$ba <- factor(samples$ba)
# a1 and a2 are the two after periods treated as categories with b as a reference
samples$ci <- as.numeric(sites$exp_treatment[match(samples$sitecode,sites$sitecode)] == "riffle") 
# 0 = control, 1 = riffle
samples$ai <- sites$ai[match(samples$sitecode, sites$sitecode)]
i_scaled <- scale(log10(samples$ai*100 + 0.1))
samples$i <- as.vector(i_scaled)
samples$spring <- as.integer(substr(samples$old_samplecode,1,1) %in% c(1,3,5))
u <- model.matrix(~ ba + ci + ba:ci + i + ba:ci:i + spring, data = samples)

# Data list for Stan
sdata <- list(n_obs = nrow(biota_ct),
              n_taxa = ncol(biota_ct),
              n_site = nrow(sites),
              n_sample = nrow(sample_nos),
              n_pred = ncol(u),
              n_t = max(samples$t),
              site_no = samples$site_no,
              samp_no = samples$sample_no,
              t = samples$t,
              u = u,
              c = as.matrix(biota_ct),
              s = as.matrix(ss_ct)
)

# load object oe_stats from urban_riffle_exp_S3.qmd, chunk calc_abundance_fits
oe_stats <- read.csv("small_data/riffle_baci_oe_stats.csv")
# load object pa_stats from urban_riffle_exp_S3.qmd, chunk fig-nbinom_pa_stats
pa_stats <- read.csv("small_data/riffle_baci_pa_stats.csv")
```

## Abstract

1.  Riffles are heterogeneous habitats that support diverse assemblages in natural streams. Rock riffles are often constructed as part of stream restoration practice, including in degraded urban stream ecosystems despite larger-scale limits to ecological state. Effective restoration practice requires better understanding of instream biotic responses to management actions. (47)

2.  We assessed the effects of constructed rock riffles on habitat heterogeneity and on macroinvertebrate assemblages in 6 urban streams (4\--32% effective imperviousness), comparing taxon abundance and richness in study reaches before and after (1-y and 5-y after) between the 6 reaches and 3 control reaches without riffles. (48)

3.  Riffles increased habitat heterogeneity. Macroinvertebrate assemblages in all streams were dominated by tolerant, cosmopolitan and invasive taxa before and after riffle construction. Riffles reduced the abundance and richness of tolerant taxa in less urban streams and increased their richness in more urban streams. A few became more abundant. (48)

4.  Increased heterogeneity only favours those taxa able to tolerate larger scale environmental filters that limit assemblage composition of highly disturbed ecosystems such as streams of urban catchments. (27)

5.  Riffle construction in streams of urban catchments is unlikely to have biodiversity benefits unless the limiting impacts (most likely urban stormwater runoff in areas sewage is well managed) are addressed first. (31)

## Introduction

Value of riffles as habitat. (including the importance of large emergent rocks as egg-laying sites for many taxa)

Role of riffles in stream restoration practice.

Continuing practice in urban settings despite larger-scale impacts of conventionally drained urban land.

A need for better understanding of biotic responses to habitat heterogeneity in constrained environments like urban streams to allow better prioritization of management efforts for biodiversity (and other) outcomes.

How we went about addressing that need.

## Methods

### Study area and experimental design

The experiment was a before-after-control-impact (BACI) study with the 'impact' being the construction of rock riffles in degraded urban streams. We selected sites on nine streams draining separate catchments in the eastern suburbs of Melbourne, Victoria, Australia (@fig-experiment_map), and randomly allocated six as 'impact' sites in which riffles were constructed, and three as 'control' sites. All sites were sampled twice in the year before riffle construction, and twice in each of two 'after' periods: *A1* in the first year and *A2*, 5 and 6 years after riffle construction. We inferred effects of the riffles from the interactions between the before-after and control-impact effects: short-term effects using the before-*A1* difference and long-term effects using the before-*A2* difference.

The streams' catchments all included conventionally drained [sensu @burns2012] urban land with effective imperviousness (EI) ranging from 4 to 32% (@fig-experiment_map). EI was estimated from 2004 imagery [@grace_gis_2012]: there was little urban growth since the study began. We further assessed if the effects of riffles differed with degree of urbanization by assessing the three-way interactions between before-after (both *A1* and *A2*), control-impact and effective imperviousness.

Candidate sites were selected from channelized (or at least straight), incised reaches, with little or no riparian vegetation, and no differentiation of riffle or pool, in the sedimentary marine and alluvial deposits of Melbourne's eastern suburbs. Reaches needed to be long enough to encompass a pool-riffle-pool sequence in a restored channel. We surveyed the selected the 9 sites using a theodolite. The thalweg of all reaches showed a wave form. We selected the wave crest as the location for the riffle (sampled for macroinvertebrates before and after riffle construction). We consulted with an engineer who designed and supervised the construction of riffles in these segments on the six 'impact' streams in May 1996. The riffles were 9\--22-m long, with approximately 4:1 upstream and 40:1 downstream slopes, and made of angular rocks with mean diameters 15-40 cm (Appendix S1). The original study design called for two rock-size treatments (graded and large: @walsh2001), but the grade of rocks delivered did not differ strongly between sites, and are considered a single treatment in this analysis. The minimum diameter was larger than the diameter of material at incipient motion for all streams, based on calculations of tractive force from the reach surveys. This riffle design is typical of river management practice in Melbourne's urban streams. The sampled segments were left unchanged in the three control streams, but it is noteworthy that by the mid 2000s, management authorities had constructed similar rock riffles on the sampled segments of two of the control reaches.

```{r}
#| label: fig-experiment_map
#| echo: false
#| fig-width: 5
#| fig-height: 6.5
#| warning: false
#| message: false
#| fig-cap: "Map of experimental sites (6 sites in which riffles were constructed and 3 control sites) and their catchments. The extent of impervious coverage (in 2004, gray basemap), piped sections of streams (dark grey stream lines), and the percentage effective imperviousness of each catchment indicate the range of urban impacts among the sites."

streams <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "streams", quiet = TRUE)
pipes <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "pipes", quiet = TRUE)
cats <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "cats", quiet = TRUE)
coast <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "coast", quiet = TRUE)
victoria <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "victoria", quiet = TRUE)
australia <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "australia", quiet = TRUE)
ia <- terra::rast("data/ia_5m_raster.tif")
#Colour sites by experimental treatment (see: https://colorbrewer2.org/)
sites$col <- 
  RColorBrewer::brewer.pal(3,"Dark2")[match(sites$exp_treatment == "riffle",0:1)]
sites$reach <- substr(sites$sitecode, 1, nchar(sites$sitecode) - 1)

layout(matrix(c(1,2,1,3,1,4,1,5),4,2,byrow = TRUE), 
       widths = c(10,2.5), heights = c(8,8,4,4))
par(mar = c(0,0,0,0))
plot(cats$geom, pch = 21, border = "white")
terra::plot(ia, col = gray(0.5), legend = FALSE, axes = FALSE, add = TRUE)
plot(cats$geom, border = sites$col[match(cats$reach,sites$reach)], 
     col = scales::alpha(sites$col[match(cats$reach,sites$reach)],0.25),
     lwd = 2, add = TRUE)
plot(streams$geom, col = "dodgerblue", add = TRUE)
plot(pipes$geom, col = gray(0.25), add = TRUE)
# # Function to find optimal point for polygon label. Result saved because
# # rgeos is being retired in 2023
# x <- rgeos::polygonsLabel(as_Spatial(cats), doPlot = FALSE)
# x <- data.frame(ei_label = 
#                   paste0(round(100*sites$ai[match(cats$site,sites$site)]),"%"),
#                 mgae = x[,1], mgan = x[,2])
# write.csv(x, "small_data/cat_polygon_label_points.csv",row.names = FALSE)
labels <- read.csv("small_data/cat_polygon_label_points.csv")
text(labels$mgae, labels$mgan, labels$ei_label, font = 2)
plot(coast$geom, lwd = 2, add = TRUE)
plot(sites$geometry, pch = 21, bg = sites$col, add = TRUE) # so that the sites are on top
rng <- par('usr')
suppressWarnings(
prettymapr::addscalebar(pos = "bottomright", label.cex = 1, plotepsg = 28355))
box()
rngPoly <- st_sfc(st_polygon(list(rbind(rng[c(1,3)], rng[c(1,4)], rng[c(2,4)], 
                                 rng[c(2,3)],rng[c(1,3)]))))
rngPoly <- st_sf(a = 1, geom = rngPoly)
# Legends
plot.new()
legend("center", pch = c(21,21,15), pt.cex = c(1,1,2), 
       pt.bg = c(RColorBrewer::brewer.pal(3,"Dark2"),NA),
       col = c("black","black",gray(0.5)),
       legend = c("Control","Riffle","Impervious"),bty = "n")
box()
plot.new()
legend("center", lty = 1, col = c("dodgerblue",gray(0.25)),
       legend = c("Stream","Piped stream"),bty = "n")
box()
# Location maps
st_crs(rngPoly) <- 28355
rngPoly <- rngPoly %>% st_transform(4283)
par(mai = c(0.028,0.028,0.028,0.028) * 0)
plot(australia$geom)
plot(victoria$geom, col = "white", add = TRUE)
polygon(c(142.9651,146.5656,146.5656,142.9651),c(-39.1122,-39.1122,-36.4374,-36.4374), col = scales::alpha(gray(0.5),0.5))
plot(rngPoly$geom, col = "black", add = TRUE)
title(main = "Australia", adj = 0, 
      font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
bounds <- st_sfc(st_point(c(143.5,-36.5)), st_point(c(146.5,-39.1)),crs=4283)
plot(bounds, col = "white")
plot(victoria$geom, add = TRUE)
rng_vic <- par("usr")
plot(rngPoly$geom, col = scales::alpha(gray(0.5),0.5), add = TRUE)
title(main = "Central Victoria ", 
      adj = 1, font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
```

### Macroinvertebrate assemblage sampling and identification

Data were collected at the nine sites on six occasions; twice prior to the installation of riffles (Nov 1995, Feb 1996), and four times after riffle installation (Nov 1996, Feb 1997, Dec 1999, Feb 2001). On each occasion, we collected replicate macroinvertebrate sample units (4 on occasions 1-4, 3 in Dec 1999 and Feb 2001) at each site using a 0.04 m^2^ suction sampler [@boulton1985]. To take a sample, one operator disturbed sediments in the sample quadrat with a spatula and scrubbed larger surfaces with a small brush while the second operator pumped out the sampler contents into a 250 $\mu$m net.

We processed sample units separately, and considered the set of replicates collected from each site on each occasion a sample. Each sample unit was preserved in 2% formaldehyde. In the laboratory, many sample-units were subsampled to reduce processing time. Initially, some samples were fully processed to develop the subsampling protocol reported by [@walsh1997], which was followed in processing all subsequent samples. The protocol requires a 0.1 subsample to be sorted, followed, if necessary, by additional subsamples until 300 specimens have been collected. Trends in subsample proportions over the 6 sampling periods differed among the study sites, potentially leading to differing biases in abundance estimates over time and among sites [@buonaccorsi_2010; @kery_schaub_2011]. We thus accounted for subsampling error in our statistical models (see below). Macroinvertebrates were identified to lowest practicable taxonomic level and counted (See Appendix S2 for more detail).

### Environmental variable determination

After each sample unit was collected, the sampler was removed from the stream bed, and water depth and velocity at the bed surface were measured at the four corners of the sampled area and the centre point. We measured velocity with a CMC 20 current meter counter, fitted with a 1-94.22 propeller, for 10 s at each point, 4 cm above the bottom (the lowest possible setting). From these five measurements, we calculated the mean and variance of velocity for each sample unit.

We noted the proportions, using Braun-Blanquet classes, of sediment particle sizes classed by the Wentworth scale [@allan2021], and used these data to estimate minimum, median, and maximum $\Phi$ (-log~2~ smallest diameter) of the sediments in each sample unit.

<!--# In the laboratory, after macroinvertebrates were collected from the sample, we separated the sample material into fine and coarse particulate organic matter (FPOM, and CPOM, respectively), wood, macrophyte leaves and algae. Each of these elements was dried at 60°C for 24 h and weighed. (I needed to dig up lab methods to make sure this is correct, but the data did not show strong trends, and I have my doubts about the realism of the OM collected as part of the macroinvertebrate sample being a reliable estimate of available resources in the sample unit. So, I have elected to omit these data.  -->

We compiled these data into 6 environmental variables to assess the effect of riffles on habitat heterogeneity at the scale of sample units: mean velocity, variance of velocity, mean depth, variance of depth, and minimum and median $\Phi$ (the latter showed similar results to maximum $\Phi$).

### Statistical models

We used a similar model structure to assess the effect of the riffles on environmental variables, and on the abundances of macroinvertebrate taxa collected in each sample unit. In all cases, the effects of primary interest were the interaction between the before-after effect (*BA*) and the control-impact effect (*CI*), and the three way interaction between BA, CI and (transformed and scaled) catchment effective imperviousness (*I*), which indicate an effect observed after riffle construction in impact sites that was not observed in control sites.

The environmental variables, except $\Phi$, were log-transformed. In each case, we modeled the resulting variable in each sample unit $y_i$ as a normal distribution. Thus:

$$
y_i \sim \textrm{Normal}(\mu_i, \sigma)
$$ {#eq-env_var_likelihood}

where $\mu_i$ is the mean value of the variable in sample unit, *i*, and $\sigma$ is the standard deviation.

We modeled $\mu_{i}$ as a linear model of 5 fixed predictors and four 3 random predictors, thus:

$$
\begin{align}
\mu_{(i)} \sim \ &\alpha + \beta\_ba * BA_i + \beta\_ci * CI_i  + \beta\_baci * BA_i * CI_i + \beta\_i * I_i \ +\\
& \beta\_bacii * BA_i * CI_i * I_i + \beta\_i * I_i + \theta_{1(si)} + \theta_{2(sa)} + \theta_{3(t)}
\end{align}
$$ {#eq-env_var_linear_model}

where $\alpha$ is the model intercept , $\beta\_ba$ is the *BA* effect (a categorical variable with values before, first year after, *A1*, and fifth/sixth year after, *A2)*, $\beta\_ci$ is the *CI* effect, $\beta\_baci$ is the interaction of the *BA* and *CI* effects, and $\beta\_bacii$ is the interaction of the *BA*, *CI* and *I* effects. The $\theta$ and $\epsilon$ parameters model the error structure of the dataset. $\theta_{1(i,si)}$ models variation among samples within each site, indexed by *si*. $\theta_{2(i,sa)}$ models variation among the four sample units within each sample, indexed by *sa*. $\theta_{3(i,t)}$ models variation among samples within each sampling campaign, indexed by *t*.

We modeled the total count of taxon *j* in each sample unit, *i*, ($Y_{i,j}$) as a negative binomial distribution (given the highly skewed distributions of taxon counts) and the count of taxon *j*, ($c_{i,j}$), in a subsample of sample unit *i* as a binomial distribution given the subsample proportion $s_{i,j}$ and $Y_{i,j}$. Thus:

$$
\begin{align}
&Y_{i,j} \sim \textrm{Neg. Binomial}(\mu_{i,j}, \phi_{j}) \\
\\
&c_{i,j} \sim \textrm{Binomial}(s_{i,j}, Y_{i,j})
\end{align}
$$ {#eq-multi_taxon_count_likelihood}

where $\mu_{i,j}$ = the mean total count of taxon *j* in sample unit *i*, and $\phi_j$ = the dispersion parameter of the negative binomial distribution for taxon *j*.

We modelled $\mu_{i,j}$ as a linear model of 6 fixed predictors and four 4 random predictors, thus:

$$
\begin{align}
\mu_{(i,j)} \sim \ &\alpha_j + \beta\_ba_{j} * BA_i + \beta\_ci_{j} * CI_i  + \beta\_baci_{j} * BA_i * CI_i + \beta\_i_j * I_i \ +\\
& \beta\_bacii_{j} * BA_i * CI_i * I_i + \beta\_i_j * I_i + \beta\_{s}_j * S_i \ +\\
& \theta_{1(si,j)} + \theta_{2(sa,j)} + \theta_{3(t,j)}+ \epsilon_{(i,j)}
\end{align}
$$ {#eq-multi_taxon_linear_model}

where $\alpha_j$, $\beta\_ba_{j}$, $\beta\_ci_{j}$, $\beta\_bacii_{j}$, and $\beta\_i_{j}$ are as described for the environmental variable model, but with a separate value for each taxon *j*. We added an effect of season (*S*: autumn = 0, spring = 1) $\beta\_s_{j}$ to account for seasonal differences in macroinvertebrate abundances. $\theta_{1(si,j)}$, $\theta_{2(sa,j)}$ and $\theta_{3(t,j)}$ are as described for the environmental variable model, with a separate value for each taxon *j*. We added an additional error term,$\epsilon_{(i,j)}$, to control for overdispersion in abundance distributions.

All $\beta$ parameters were formulated as random effects drawn from community-level hyper-distributions with the mean parameters specified as diffuse normal distributions (mean 0, sd 5) and the parameters for each species drawn from a multivariate normal distribution with a variance-covariance matrix that describes the residual associations among species. Prior distributions for the random effect parameters for site ($\theta_{si}$) and sample ($\theta_{sa}$) normal, with mean 0 and sds drawn from hyper-distributions among sites and samples, respectively, as was the sampling occasion parameter ($\theta_{t}$, among sampling occasions). Broadly, the sd of the random effect distributions were the constraining parameters for model convergence in many models, and we varied their prior distributions among models to maximise sampling convergence (see Appendix S3 for details). For the multi-taxon model, the parameter modelling error among sample units ($\epsilon$), and the dispersion parameter ($\phi$) of the negative binomial distribution for each taxon both had weakly informative normal prior distributions (mean 1, sd 1). We derived the models using the Markov chain Monte Carlo sampler of Stan [@carpenter_etal_2017].

The multi-taxon model satisfied tests for convergence, and effective sample size. The Bayesian Fraction of Missing Information (mean 0.299) was marginally lower than the nominal threshold of 0.3 ( @stan_dev_team_2022: see Appendix S3 for more details). (*The environmental variable models were more problematic, with a small number of divergences, and low BFMI for mean depth and velocity and variance of velocity...sigma_sa (and perhaps a_sa\_ seem to be the limiting parameters. I'm not sure how to better parameterize them*...*Also, I haven't yet done the next step of assessing model accuracy for the environmental variables. I wonder if it's worth the trouble. The models sample the main fixed variables of interest well, and show the fairly obvious differences that we need to illustrate...Perhaps there is an easier way to achieve that aim?)*

We quantified model accuracy by correlation coefficients (R) between observed and predicted abundances of each taxon in each sample (log-transformed, averaged for sample units comprising each sample). To assess potential bias in model predictions, we calculated the slope of a regression of predicted abundance as a function of observed abundance. We also assessed the accuracy of predictions of taxon occurrence by the area under the operator curve (AUC) of logistic regressions of predicted probability of occurrence as a function of observed presence or absence each taxon in each sample (see below). Finally we assessed the accuracy of model predictions of number of taxa in each sample (total and number of Ephemeroptera, Plecoptera and Trichoptera---EPT---taxa), assessing the *R^2^* of regressions between predicted and observed, accounting for subsample proportion.

The model predicted abundances of all taxa at each site well (mean R for all taxa `r round(mean(oe_stats$cor),2)` (range `r round(min(oe_stats$cor),2)`--`r format(round(max(oe_stats$cor),2), nsmall = 2)`), without bias for the `r sum(oe_stats$slope > 0.8)` taxa (mean slope `r round(mean(oe_stats$slope[oe_stats$slope > 0.8]),2)`, range `r round(min(oe_stats$slope[oe_stats$slope > 0.8]),2)`--`r round(max(oe_stats$slope[oe_stats$slope > 0.8]),2)`). Abundances of `r sum(oe_stats$slope <= 0.8)` taxa with lower prevalence and abundance tended to be underestimated (mean slope `r round(mean(oe_stats$slope[oe_stats$slope <= 0.8]),2)`). However, the occurrences of all taxa were well predicted by the model (AUC \> `r format(round(min(pa_stats$AUC, na.rm = TRUE),2),nsmall = 2)`), and the sums of predicted probabilities of occurrence predicted numbers of taxa per sample well. The regression of predicted number of taxa as a function of observed had *R^2^* = 0.63, with predicted number of taxa being greater than observed for samples with few observed taxa. However, this was likely because most such samples had smaller subsample fractions than more taxa-rich samples. The regression of predicted as a function of observed + subsample proportion had a higher *R^2^* (0.73). Numbers of EPT taxa were well predicted by the model (*R^2^* = 0.92), with a smaller effect of subsample size. See Appendix S3 for more detail. The good fit of the model predictions to the data provides confidence in inferences of the *BA*, *CI* and *I* effects, which are the focus of this study.

### Model interpretation

To interpret interactions between the effects of riffle construction and degree of catchment urbanization, we derived posterior predicted distributions of abundances of taxa for which the interactions of interest were non-zero with at least 90% confidence for 12 scenarios. The scenarios comprised four site types (control and impact sites with high and low effective imperviousness (4% and 32% EI, the maximum and mimimum EI values in the study sites, respectively), in the three states of the BA effect (*B*, before; *A1*, in the first year after riffle construction; and *A2*, 5-6 years after).

We focused first on taxa for which the *BA:CI* or *BA:CI:I interactions* were non-zero with at least 90% confidence to understand which taxa drove assemblage-level differences. We also derived predictions of responses of assemblage-level metrics from the model for each of the 12 scenarios. Responses of diversity measures such as richness are of intrinsic community ecological interest, but they and biotic metrics focussing on taxa of differing sensitivity to human disturbance are used by stream managers as measures of ecological condition and targets for responses to management actions (e.g. @vic_gov_2018). We used predicted abundances and occurrences for each scenario to calculate posterior distributions of:

-   Total macroinvertebrate abundance, of EPT taxa (insect orders dominated by taxa sensitive to human disturbance, @resh_jackson_1993), and of Diptera and Oligochaeta (QDLO, groups dominated by taxa tolerant to human disturbance, @gooderham_tsyrlin_2002).

-   Total taxon richness (i.e. taxon density, the number per sample comprising 4 sample units), also EPT and QDLO richness

-   SIGNAL, a biotic index which averages grades of sensitivity to human disturbance (between 1 and 10) of families present in a sample [@chessman_1995].

Abundance measures were calculated by adding predicted mean abundances per sample unit of the relevant taxa. Richness measures were derived by first calculating predicted probability of occurrence in a sample,

$$
p\_s = 1 - \Pi(1 - p\_{su}_i)
$$ {#eq-predict_pa}

where $p\_su_i$ is the probability of occurrence in the *i*th sample unit comprising the sample, calculated as 1 - negative-binomial probabliity of zero, given predicted $\mu$ and $\phi$. Number of taxa in each sample was calculated as the sum of probabilities of occurrence (see Appendix S3 for more detail).

To assess the probability of an effect of riffle construction on environmental variables, assemblage metrics and taxon abundances, we calculated the following four differences between the posterior distributions of metrics and abundances given the 12 scenarios:

-   $\Delta A1 \, (\textrm{4%} \, EI)$, (control minus impact before, *B*) - (control minus impact in first year after, *A1*) for low *I*

-   $\Delta A2 \, (\textrm{4%} \, EI)$, (control minus impact before, *B*) - (control minus impact 5-6 y after, *A2*) for low *I*

-   $\Delta A1 \, (\textrm{32%} \, EI)$, (control minus impact before, *B*) - (control minus impact in first year after, *A1*) for high *I*

-   $\Delta A2 \, (\textrm{32%} \, EI)$, (control minus impact before, *B*) - (control minus impact 5-6 y after, *A2*) for high *I*

We inferred a likely effect of riffle construction on each measure if \>90% of the posterior distribution of any one of the differences was greater than zero (indicating that the measure in impact sites increased relative to control sites following riffle construction) or less than zero (indicating a decline in impact sites relative to control sites).

## Results

### Responses of environmental variables

The constructed riffles altered the available substrates in the study reaches, increasing surface and hydraulic heterogeneity.

Riffles resulted in shallower water through the reach (@fig-cf_env_vars C, D, although no change in variability in depth at the sample-unit scale: @fig-cf_env_vars A, B), and increased mean velocity, and variance of velocity (@fig-cf_env_vars E-H), indicating increased heterogeneity of the hydraulic environment.

Before riffle construction, and in control sites throughout the study, median $\Phi$ before was 1 to 6 (sand to clay). Riffles reduced median $\Phi$ to -6 to -7 (small to large cobbles) in sites with low EI, and this change persisted for 6 years (A2, @fig-cf_env_vars L). In sites with high EI, riffles had a smaller effect on median $\Phi$, reducing in the first year to -2 (gravel), but increasing to 1 (coarse sand) after 6 years, as sand deposited among the riffles (@fig-cf_env_vars K, L).

Riffles more consistently reduced minimum $\Phi$ (i.e. introduced larger particles) to -6 to -7 in all impact sites. However, the effect of riffle construction on minimum $\Phi$ was small in sites with low EI, which contained some large pebbles before riffle construction (@fig-cf_env_vars I, J). A further effect of the riffles not quantified by these measurements was an increase in the availability of large emergent rocks (See photos in S1).

```{r}
#| label: fig-cf_env_vars
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 6
#| fig-cap: "Posterior distributions of the differences in abundance for the four contrasts illustrating the effect of riffle construction (A, C, E, G, I, K) and trends from before to after riffle construction (B, D, F, H, J, L) in 6 environmental variables. A, B. Mean water depth, C, D. Variance of water depth within each 0.04 m^2 sample unit, E, F, Mean velocity, G, H. Variance of velocity, I, J. Minimum $\\Phi$ (the negative log of diameter of sediment particles in the sample unit). K, L. Maximum $\\Phi$. For the distribution plots, 95th, 90th, and 75th percentiles are indicated by increasingly thick bars. Coefficients with >90% less than zero are red, and >90% greater than zero blue. The four lines in each trend plot connect mean (± 95% confidence intervals) metric values  before (B) and at two times after (A1, in the first year, and A2, 5-6 years later) construction of the experimental riffles for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI). (Note: depth and velocity plots are log-transformed: I still need to transform their axes."

# load cfs, list of 12 data frames (one for each environmental variable), with
# percentile statistics of posterior distributions for 60 counterfactual scenarios
# including the 12 plotted here
load("small_data/env_var_predy_cf.rda")

# Function for unscaling environmental variables for plotting
unscale <- function(y_scaled_transformed, x, scaled = TRUE, log = TRUE, log_add = 0){  
  #y_scaled_transformed is modelled output of variable x calculated on scaled 
  # (if scale = TRUE), and logged (if log = TRUE) data, x
  #x is the original vector of raw modelled data before transformation (if log = TRUE) and scaling
  # log_add is the amount added before logging to avoid log(0)
  if(log){
  x_transformed <- log(x + log_add)
  }else{
      x_transformed <- x
  }
  if(scaled){
  scale_x <- scale(x_transformed) 
  y_transformed <- y_scaled_transformed * attr(scale_x, 'scaled:scale') + 
                                  attr(scale_x, 'scaled:center')
  }else{
    y_transformed <- y_scaled_transformed
  }
  if(log){
    y <- exp(y_transformed) - log_add
  }else{
    y <- y_transformed
  }
  list(y_transformed = y_transformed, 
       y = y)
}
y_transform_pars <- data.frame(stat = names(cfs),
                               scaled = c(TRUE,FALSE,rep(TRUE,10)), 
                               log = c(rep(TRUE,9),rep(FALSE,3)), 
                               log_add = c(1.75e-04,0,0.0007442,0,0.001,
                                           0.001,0.0094382,0.001,5e-04,0,0,0))

# load env_diff_summs, a data.frame with the percentile statistics of posterior
# distributions of the four BACI contrasts for each of the 12 environmental variables
load("small_data/env_diff_summs.rda")
diffs <- c("delta_baci1_hi","delta_baci2_hi","delta_baci1_low","delta_baci2_low")
nms <- c( bquote(Delta~"A2 4% EI"), bquote(Delta~"A1 4% EI"), 
          bquote(Delta~"A2 32% EI"),bquote(Delta~"A1 32% EI"))
ylabs <- c("A2,4%EI","A1,4%EI","A2,32%EI","A1,32%EI")
ylabs1 = c("Variance of depth (cm)", "Mean depth (cm)","Variance of velocity (m/s)", 
          "Mean velocity (m/s)", "CPOM (g)", "CPOM with wood (g)", "FPOM (g)",
          "Algae (g)", "Macrophyte (g)", "Minimum Phi","Maximum Phi",
          "Median Phi")
# cols <- ggsci::pal_jco(palette = c("default"), alpha = 1)(4)
# spell them out so that they are displayed in Rstudio
cols <- c( "#CD534CFF","#EFC000FF","#868686FF","#0073C2FF")

vars_to_plot <- which(names(cfs) %in% c("depth_m_var","depth_m_mean","vel_m_s_var",
                                        "vel_m_s_mean","min_phi","med_phi"))

layout(matrix(c(1:12,rep(13,4)),4,4,byrow=TRUE), widths = c(10,10,10,10),heights = c(10,10,10,2))
for(i in vars_to_plot){
  panel_index <- which(vars_to_plot == i)
# Difference distribution plot
  miny <- 0.5; maxy <- 4.5
  summp <- env_diff_summs[env_diff_summs$stat == names(cfs)[i],]
  summp <- summp[match(diffs,summp$diff),]
  par(mar = c(4,5,1,0))
  xrange <- c(min(summp$lo95),max(summp$hi95))
  plot(xrange,c(miny,maxy),type = 'n', axes = FALSE, xlab = "Difference",ylab = "")
  for(j in 1:4){
    lines(c(summp$lo95[j],summp$hi95[j]),rep(miny+maxy-j,2),lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    lines(c(summp$lo90[j],summp$hi90[j]),rep(miny+maxy-j,2), lwd = 2,lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    lines(c(summp$lo75[j],summp$hi75[j]),rep(miny+maxy-j,2), lwd = 4,lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    points(summp$mean[j],miny+maxy-j,pch = 21, 
           bg = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
  }
  axis(1); 
  axis(2, at = 1:4, labels = ylabs, las = 1) 
  box(bty = 'l')
  abline(v = 0, lty = 3)
  title(main = paste0(LETTERS[(panel_index-1)*2 + 1],". "), adj = 0)

# Trend plot
  cfi <- cfs[[i]]
  combos <- list(control_hii = which(cfi$ci == 0 & cfi$i == max(cfi$i)),
                 impact_hii = which(cfi$ci == 1 & cfi$i == max(cfi$i)),
                 control_lowi = which(cfi$ci == 0 & cfi$i == min(cfi$i)),
                 impact_lowi = which(cfi$ci == 1 & cfi$i == min(cfi$i)))
  x_adjs <- c(-0.03, -0.01, 0.01, 0.03)
  ylabi <- ylabs1[i]
  names(cfi)[match(c("mean","X2.5.","X97.5."),names(cfi))] <- c("pred","lo","hi")
  cfi[c("pred","hi","lo")] <- unscale(cfi[c("pred","hi","lo")],
                                        x = as.numeric(samples[,y_transform_pars$stat[i]]),
                                        scaled = y_transform_pars$scaled[i],
                                        log = y_transform_pars$log[i],
                                        log_add = y_transform_pars$log_add[i])$y_transformed
  cfi1 <- cfi[combos[[1]],]
       plot(0:2 + x_adjs[1], cfi1$pred, ylim = c(min(cfi$lo),max(cfi$hi)), 
            type = 'b', col = cols[1], pch = 16, axes = FALSE, xlim = c(0,2),
            xlab = "", ylab = ylabi)
  lines(0:2 + x_adjs[2], cfi$pred[combos[[2]]],
                                col = cols[2], pch = 16, type = 'b')
  lines(0:2 + x_adjs[3], cfi$pred[combos[[3]]],
                                col = cols[3], pch = 16, type = 'b')
  lines(0:2 + x_adjs[4], cfi$pred[combos[[4]]],
                                col = cols[4], pch = 16, type = 'b')
  for(k in 1:ifelse(grepl("_g",names(cfs)[i]), 2,3)){
    for(j in 1:4){
      cfij <- cfi[combos[[j]],]
      lines(rep(k-1,2) + x_adjs[j], c(cfij$lo[k],cfij$hi[k]), col = cols[j])
    }
  }
  axis(1, at = 0:2, labels = c("B","A1","A2"))
  axis(2, las = 1); 
  box(bty = "l")
  title(main = paste0(LETTERS[(panel_index-1)*2 + 2],"."), adj = 0)
}
  par(mar = c(0,0,0,0))
  plot.new()
  legend("center", pch = 16, col = cols, horiz = TRUE,
   legend = c("Control, 32% EI", "Impact, 32% EI", "Control 4% EI","Impact 4% EI"),
   cex = 1)

```

### Responses of macroinvertebrate taxa

```{r}
#| echo: false
#| label: tbl-top10taxa
#| tbl-cap: "Mean abundance (N per 0.04 $m^2$ sample unit) under the 12 scenarios of the 19 taxa that were among the 10 most abundant taxa in at least one scenario, and the percentage of the total count of all taxa in each scenario that the 19 taxa constitute.  Low and High I, 4% and 32% effective imperviousness, respectively; B, Before; A1, in the first year after; A2, 5-6 years after riffle construction. See Appendix S2 for explanation of Tubificinae taxa."

top10taxa <- read.csv("small_data/top10taxa.csv")
ft <- flextable::flextable(top10taxa[,-1]) 
ft <- ftExtra::span_header(ft, sep = "_")
ft <- flextable::align(ft, align = "center", part = "header")
ft <- flextable::italic(ft, i = which(top10taxa$taxoncode %in% taxa$taxoncode[taxa$italic == 1]), j = 1)
ft <- flextable::bold(ft, i = nrow(top10taxa))
ft <- flextable::hline(ft, i = nrow(top10taxa)-1)
ft
```

The macroinvertebrate assemblages of all sites were numerically dominated by cosmopolitan taxa, tolerant of human disturbance, although the most abundant taxa tended to be less abundant, and constituted a lower proportion of the assemblage, in sites with lower EI (@tbl-top10taxa). *Potamopyrgus antipodarum*, *Physa acuta*, *Lumbriculus variegatus*, and likely members of other taxa, are invasive species. Thus, despite the sites spanning a gradient of EI from 4-32%, the biota of all sites were dominated by taxa typical of degraded urban streams, and this general state was consistent across before and after periods, although @tbl-top10taxa suggests some reduction in the dominance of some cosmopolitan taxa after riffle construction in low EI impact sites.

```{r}
#| echo: false
#| warning: false
#| message: false

# Load summary statistics for the fixed parameters (created in predy_summary chunk in `urban_riffle_exp_S3.qmd`)
param_summs <- rio::import_list("small_data/param_summs.xlsx")

# load summary statistics for the 4 contrasts (created in pred_cf chunk in `urban_riffle_exp_S3.qmd`)
diff_summs <- rio::import_list("small_data/diff_summs.xlsx")

# Identify those taxa for which a difference resulting from riffle construction can be inferred
# (with 90% and 95% confidence)
more_diff_90 <- more_diff_95 <- more_sim_90 <- more_sim_95 <- vector()
for(i in 1:length(diff_summs)){
more_diff_90 <- unique(c(more_diff_90,diff_summs[[i]]$shortcode[diff_summs[[i]]$lo90 > 0]))
more_diff_95 <- unique(c(more_diff_95,diff_summs[[i]]$shortcode[diff_summs[[i]]$lo95 > 0]))
more_sim_90 <- unique(c(more_sim_90,diff_summs[[i]]$shortcode[diff_summs[[i]]$hi90 < 0]))
more_sim_95 <- unique(c(more_sim_95,diff_summs[[i]]$shortcode[diff_summs[[i]]$hi95 < 0]))
}

# Collect taxa of interest (effected by riffles or by EI) 
taxa_to_plot <- unique(c(more_diff_90,more_sim_90,
                         param_summs$b_i$shortcode[param_summs$b_i$lo90 > 0],
                         param_summs$b_i$shortcode[param_summs$b_i$hi90 < 0]))
# Prepare taxon text for figures
higher_taxa_in_plot <- higher_taxa[higher_taxa$higher_taxon %in% 
                                     unique(taxa$higher_taxon[taxa$taxoncode %in% taxa_to_plot]),]
# R results for inclusion in figure caption:
ht_string <- paste(paste0(higher_taxa_in_plot$taxon, " (", higher_taxa_in_plot$higher_taxon, ")"), collapse = "; ")
# Annelida (A); Pelecypoda (B); Coleoptera (C); Diptera (D); Ephemeroptera (E); Turbellaria (F); Gastropoda (G); Lepidoptera (L); Acarina (M); Odonata (O); Plecoptera (P); Trichoptera (T); Crustacea (Z); Cnidaria (I); Nematoda (J)
# length(taxa_to_plot) # 41 taxa to plot in @fig-coeff_plot_alt
```

23 of the 113 taxa responded to riffle construction (non-zero *BA-CI* differences with 90% confidence; 18 with 95% confidence: @fig-coeff_plot_alt). Only two of those species were negatively associated with EI (i.e. sensitive to human disturbance; @fig-coeff_plot_alt). One of those, Hydropsychidae, filter-feeding caddis flies that build nets on rocks, increased in abundance after riffle construction, in sites with low EI, and was largely absent from sites with high EI (@fig-cf_taxon_abunds A). The other, a chironomid, *Thiennemaniella*, decreased in abundance, in sites with low EI (and were largely absent from sites with high EI before and after: @fig-cf_taxon_abunds B).

Simuliidae, with similar habitat requirements to Hydropsychidae, but more tolerant of human impacts, increased in abundance in high EI sites but not low EI sites (@fig-cf_taxon_abunds C), as did Ceratopogonidae, Glossiphonidae, *Cura pinguis*, and *Pisidium* (@fig-coeff_plot_alt).

Most taxa that were positively associated with EI (i.e. tolerant of human disturbance) decreased in abundance after riffle construction, with declines more common after 5--6 years than in the first year (@fig-coeff_plot_alt). Nematoda, Cyclopoida, oligochaetes *Lumbriculus variegatus* (@fig-cf_taxon_abunds D, as an example), *Nais*, *Chaetogaster diaphanus*, Megadrili, Tubificinae groups A and B, and chironomids *Polypedilum* (@fig-cf_taxon_abunds E), as an example),*Chironomus* *Paratanytarsus/Rheotanytarsus*---most of which inhabit soft sediments---decreased in abundance in low EI sites, but not high EI sites. Enchytraeidae oligochaetes decreased in both high and low EI sites.

Chironomids *Parakiefferiella* (@fig-cf_taxon_abunds F), *Procladius* (@fig-cf_taxon_abunds G) , *Cricotopus*, and *Cryptochironomus* decreased in low EI sites over the 6 years, but increased in high EI sites in year 1 (@fig-coeff_plot_alt).

```{r}
#| label: fig-coeff_plot_alt
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 5
#| fig-cap: "Posterior distributions of the effect (b_I) of imperviousness (EI), and of differences in abundance for the four contrasts illustrating the effect of riffle construction. Each contrast estimates the change in difference between control and reference sites from before riffle construction to one of two periods after construction. The four contrasts are:ΔA1 4%, before to the first year after for sites with 4% EI; ΔA2 4%, before to the 5th/6th year after in sites for sites with 4% EI; ΔA1 32%, before to the first year after for sites with 32% EI; ΔA2 32%, before to the 5th/6th year after in sites for sites with 32% EI. For each contrast a positive trend indicates that the control and reference sites became more different, and a negative trend indicates they became more similar. For each distribution, 95th, 90th, and 75th percentiles are indicated by increasingly thick bars. Coefficients with >90% less than zero are red, and >90% greater than zero blue. Taxa are ordered by mean of b_I. Only the 41 taxa with at least one of the five distributions greater than or less than zero with >90% confidence are shown. Taxonomic affiliations are indicated parenthetically: Annelida (A); Pelecypoda (B); Coleoptera (C); Diptera (D); Ephemeroptera (E); Turbellaria (F); Gastropoda (G); Lepidoptera (L); Acarina (M); Plecoptera (P); Trichoptera (T); Crustacea (Z); Nematoda (J)."

lo <- layout(matrix(c(1:5,0,rep(6,4)),2,5,byrow = TRUE),widths = c(25,rep(10,4)),heights = c(60,2))
taxa$labs <- paste0(taxa$taxon," (", taxa$higher_taxon,")")
taxa_to_plot_df <- taxa[taxa$taxoncode %in% taxa_to_plot,]
taxa_in_order <- param_summs$b_i$shortcode[order(param_summs$b_i$mean, decreasing = FALSE)]
taxa_in_order <- taxa_in_order[taxa_in_order %in% taxa_to_plot]
taxa_to_plot_df <- taxa_to_plot_df[match(taxa_in_order, taxa_to_plot_df$taxoncode),]
miny <- 1; maxy <- length(taxa_to_plot)

  nms <- c("b_i", bquote(Delta~"A1 4% EI"), bquote(Delta~"A2 4% EI"), 
                  bquote(Delta~"A1 32% EI"), bquote(Delta~"A2 32% EI"))
for(p in 1:5){
  if(p == 1){
  summp <- param_summs[["b_i"]]
  }else{
    summp <- diff_summs[[p-1]]
  }
  summp <- summp[match(taxa_in_order,summp$shortcode),]
par(mar = c(2,ifelse(p == 1, 13, 1),1,0))
  plot(c(min(summp$lo95),max(summp$hi95)),c(miny+1,maxy-1),
       type = 'n', axes = FALSE, xlab = "",ylab = "")
for(i in miny:maxy){
  lines(c(summp$lo95[i],summp$hi95[i]),rep(miny+maxy-i,2),lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo90[i],summp$hi90[i]),rep(miny+maxy-i,2), lwd = 2,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo75[i],summp$hi75[i]),rep(miny+maxy-i,2), lwd = 4,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  points(summp$mean[i],miny+maxy-i,pch = 21, 
        bg = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
}
axis(1)
if(p == 1){
axis(2,at = (miny:maxy)[rev(taxa_to_plot_df$italic == 0)],
     labels = rev(taxa_to_plot_df$labs[taxa_to_plot_df$italic == 0]), cex.axis = 0.9, las = 1)
axis(2,at = (miny:maxy)[rev(taxa_to_plot_df$italic == 1)],
     labels = rev(taxa_to_plot_df$labs[taxa_to_plot_df$italic == 1]), 
     cex.axis = 0.9, font.axis = 3, las = 1)
}
abline(v = 0, lty = 3)
title(main = nms[p])
  }
par(mar = c(0,0,0,0))
plot.new()
title(xlab = "Coefficient", line=-1, cex.lab = 1.25)
```

```{r}
#| label: fig-cf_taxon_abunds
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Trends in abundance of 8 taxa as examples of the main trend patterns observed in taxa for which an effect of riffle was inffered with >90% confidence. The four lines in each plot connect mean (± 95% confidence intervals) metric values  before (B) and at two times after (A1, in the first year, and A2, 5-6 years later) construction of the experimental riffles for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI)."

# (Plot examples: 
example_taxa <- c("QT06","QDAF07","QD10","LO060101","QDAI08","QDAE08","QDAF03")
# 7 examples referred to in text: Hydropsychidae,  Thienemanniella, Simuliidae, 
# Oligochaete  and chironomid examples of decline in low EI (Lumbriculus and Polypedilum),  
# and Parakiefferiella and Procladius from the last group

predx_cf <- expand.grid(intercept = 1, ba = factor(c(0,1,2)), ci = c(0,1), 
                        i = seq(min(u[,5]),max(u[,5]),length=10), spring = 0)
predx_cf <- data.frame(model.matrix(~ ba + ci + ba:ci + i + ba:ci:i + spring, 
                                    data = predx_cf))
predx_cf$ai <- 10^(predx_cf$i * attr(i_scaled, 'scaled:scale') + 
                attr(i_scaled, 'scaled:center')) - 0.1

# The 12 scenarios for calculating differences  
combos <- list(control_hii = which(predx_cf$ci == 0 & predx_cf$i == max(predx_cf$i)),
               impact_hii = which(predx_cf$ci == 1 & predx_cf$i == max(predx_cf$i)),
               control_lowi = which(predx_cf$ci == 0 & predx_cf$i == min(predx_cf$i)),
               impact_lowi = which(predx_cf$ci == 1 & predx_cf$i == min(predx_cf$i)))

taxa_baci <- unique(c(more_diff_90,more_sim_90))
taxa_set <- example_taxa 

# summary stats of posterior predictions for all taxa in 12 combos scenarios
# Compiled in urban_riffile_S3.qmd, chunk "pred_cf"
taxon_abun_cf_summs <- rio::import_list("small_data/taxon_abun_cf_summs.xlsx")
predx_cfs <- predx_cf[unlist(combos),]
lo <- layout(matrix(c(9,1:4,9,5:8,0,rep(10,4)),3,5,byrow = TRUE),
widths = c(1,12,10,10,10),heights = c(10,12,1))
for(i in 1:7){  #
par(mar = c(ifelse(i %in% 5:8, 4,1), ifelse(i %in% c(1,5),5,1),1,1))
cfi <- data.frame(predx_cfs, col = rep(cols,each=3),
                  xpos = rep(0:2,4),
                  x_adj = rep(c(-0.03,-0.01,0.01,0.03),each = 3),
                  pred = NA, lo = NA, hi = NA)
for( j in 1:nrow(cfi)){
  predj <- taxon_abun_cf_summs[[j]]
  cfi[j, c("pred","lo","hi")] <- predj[predj$taxoncode == taxa_set[i],
                                       c("mean","lo95","hi95")]
}

with(cfi[1:3,], plot((0:2) + cfi$x_adj[1:3], pred, type = 'b',
                                    col = cols[1], pch = 16, axes = FALSE,
                                    ylim = c(-12,8), # ylim = c(-14,5), #
                                    xlab = "", ylab = ""))
with(cfi[4:6,], lines((0:2) + cfi$x_adj[4:6], pred,
                    col = cols[2], pch = 16, type = 'b'))
with(cfi[7:9,], lines((0:2) + cfi$x_adj[7:9], pred,
                    col = cols[3], pch = 16, type = 'b'))
with(cfi[10:12,], lines((0:2) + cfi$x_adj[10:12], pred,
                    col = cols[4], pch = 16, type = 'b'))
for(j in 1:12){
lines(rep(cfi$xpos[j],2) + cfi$x_adj[j], c(cfi$lo[j],cfi$hi[j]), col = cfi$col[j])
}
if(i %in% 5:8){
  xlabs <- c("B","A1","A2")
      }else{
  xlabs <- rep(" ",3)
     }
axis(1, at = 0:2, labels = xlabs)
if(i %in% c(1,5,9)){
  ylabs <- c("","0.0001",0.001,0.01,0.1,1,10,100,1000,"10000")
      }else{
  ylabs <- rep(" ",10)
      }
axis(2, las = 1, at = log(c(0.00001,0.0001,0.001,0.01,0.1,1,10,100,1000,10000)),
labels = ylabs)
box(bty = "l")
if(taxa$italic[taxa$taxoncode == taxa_set[i]] == 1){
title(main = bquote(paste(.(LETTERS[i]), # taxa$taxoncode[taxa$taxoncode == ba0cii_taxa[i]],
   ". ", italic(.(taxa$taxon[taxa$taxoncode == taxa_set[i]])))),
adj = 0, cex.main = 1)
}else{
title(main = bquote(paste(.(LETTERS[i]), # taxa$taxoncode[taxa$taxoncode == ba0cii_taxa[i]],
   ". ", .(taxa$taxon[taxa$taxoncode == taxa_set[i]]))),
adj = 0, cex.main = 1)
}
}
par(mar = c(0,0,0,0))
plot.new()
legend("center", pch = 16, col = cols,
legend = c("Control, 32% EI", "Impact, 32% EI", "Control 4% EI","Impact 4% EI"),
cex = 1)
plot.new()
title(ylab = "Abundance per sample unit", line = -1, cex = 1.25)
plot.new()
title(xlab = "Occasion", line =2, cex = 1.25)
par(mar = c(4,4,1,1))
```

The common trend of reduced abundance of tolerant taxa following riffle construction in sites with low EI resulted in a reduction in total richness and, more weakly, abundance in those sites (@fig-assemb_diffs_dists A, E; @fig-assemb_diffs_dists A, E), driven largely by reduced QDLO richness (@fig-assemb_diffs_dists C; @fig-assemb_diffs_dists C) and abundance (@fig-assemb_diffs_dists G; @fig-assemb_diffs_dists G). Conversely, total and QDLO richness (but not abundance) increased in sites with high EI (@fig-assemb_diffs_dists C; @fig-assemb_diffs_dists C).

Neither EPT richness nor abundance changed following riffle construction (@fig-assemb_diffs_dists B, F; @fig-assemb_diffs_dists B, F), although the increased abundance of Hydropsychidae in sites with low EI drove a tendency for both EPT metrics to increase in those sites (with P \< 0.9).

Overall, the changes in abundance and richness of tolerant taxa following riffle construction did not alter the dominance of the macroinvertebrate assemblages by tolerant, cosmopolitan and invasive species (@tbl-top10taxa). We found no evidence of colonization by less tolerant species. As a result the low-moderate SIGNAL scores for these sites were unchanged over the study (@fig-assemb_diffs_dists D; @fig-assemb_diffs_dists D).

```{r}
#| label: fig-assemb_diffs_dists
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Posterior distributions of the differences in abundance for the four contrasts illustrating the effect of riffle construction for seven assemblage metrics. A. Total richness, B. Ephemeroptera, Plecoptera and Trichoptera (EPT) richness C. Dipteran and Oligochaete (QDLO) richness, D. SIGNAL score, E. total abundance, F. EPT abundance G. QDLO abundance. Contrasts and other conventions are as in Figure 2."

assemb_stat_summs <- readxl::read_excel("small_data/assemb_stat_diff_summs.xlsx")
# Leave out evenness and H, which do not differ with riffle construction
assemb_stat_summs <- assemb_stat_summs[!assemb_stat_summs$stat %in% c("evenness","H"),]
lab_names <- c("Total richness", "EPT richness", "QDLO richness", 
               "SIGNAL score", "Total abundance", "EPT abundance", 
               "QDLO abundance")
stat_names <- unique(assemb_stat_summs$stat)
xlabs = c("Delta No. taxa", "Delta No. tax", "Delta No. taxa", "Delta SIGNAL",
          "Delta N", "Delta, N", "Delta N")
  
lo <- layout(matrix(c(1:8),2,4,byrow = TRUE),
widths = c(14,10,10,10),heights = c(10,10))
  diffs <- c("delta_baci1_hi","delta_baci2_hi","delta_baci1_low","delta_baci2_low")
nms <- c( bquote(Delta~"A2 4% EI"), bquote(Delta~"A1 4% EI"), 
          bquote(Delta~"A2 32% EI"),bquote(Delta~"A1 32% EI"))
  miny <- 0.5; maxy <- 4.5
for(j in 1:7){
  summp <- assemb_stat_summs[assemb_stat_summs$stat == stat_names[j],]
  summp <- summp[match(diffs,summp$diff),]
par(mar = c(4,ifelse(j %in% c(1,5), 5, 1),1,0))
xrange <- c(min(summp$lo95),max(summp$hi95))
  plot(xrange,c(miny,maxy),type = 'n', axes = FALSE, xlab = xlabs[j],ylab = "")
for(i in 1:4){
  lines(c(summp$lo95[i],summp$hi95[i]),rep(miny+maxy-i,2),lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo90[i],summp$hi90[i]),rep(miny+maxy-i,2), lwd = 2,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo75[i],summp$hi75[i]),rep(miny+maxy-i,2), lwd = 4,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  points(summp$mean[i],miny+maxy-i,pch = 21, 
        bg = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
}
axis(1); 
if(j %in% c(1,5)){
  ylabs <- c("A2,4%EI","A1,4%EI","A2,32%EI","A1,32%EI")
}else{
    ylabs <- rep("",length=length(nms))
    }
axis(2, at = 1:4, 
     labels = ylabs, las = 1) 
box(bty = 'l')
abline(v = 0, lty = 3)
title(main = paste0(LETTERS[j],". ",lab_names[j]), adj = 0)
  }
par(mar = c(0,0,0,0))

```

```{r}
#| label: fig-assemb_trends
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Trends in assemblage metrics (A. total richness, B. Ephemeroptera, Plecoptera and Trichoptera [EPT] richness C. Dipteran and Oligochaete [QDLO] richness D. SIGNAL score, E. total abundance, F. EPT abundance, G. QDLO abundance) in a sample of 4 sample units) before and at two times after construction of the experimental riffles.  The four lines in each plot connect mean (± 95% confidence intervals) metric values over the three times for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI)"

assemb_stat_summs <- rio::import_list("small_data/assemb_stat_summs.xlsx")
ylabs = c("Total richness", "EPT richness", "DO richness",
          "SIGNAL score", "log(total abundance)", "log(EPT abundance)","log(QDLO abundance)")
plot_index <- match(c("tot_rich","ept_rich","do_rich","signal","tot_n","ept_n","do_n"),names(assemb_stat_summs))
par(mar = c(2,4,1,1))
par(mfrow = c(2,4))
for(i in 1:7){
  ylabi <- ylabs[i]
  if(i < 5) {
    predi <- assemb_stat_summs[[plot_index[i]]]
  }else{
      predi <- log(assemb_stat_summs[[i]])
      }
cfi <- data.frame(predx_cf, 
                  pred = predi[,1], 
                  lo= predi[,2],
                  hi= predi[,3])
with(cfi[combos$control_hii,], 
     plot((0:2) + x_adjs[1], pred, ylim = c(min(cfi$lo),max(cfi$hi)), 
          type = 'b', col = cols[1], pch = 16, axes = FALSE, 
          xlab = "", ylab = ylabi))
with(cfi[combos[[2]],], lines((0:2)+ x_adjs[2], pred,
                              col = cols[2], pch = 16, type = 'b'))
with(cfi[combos[[3]],], lines((0:2) + x_adjs[3], pred,
                              col = cols[3], pch = 16, type = 'b'))
with(cfi[combos[[4]],], lines((0:2) + x_adjs[4], pred,
                              col = cols[4], pch = 16, type = 'b'))
for(k in 1:3){
  for(j in 1:4){
    cfij <- cfi[combos[[j]],]
    lines(rep(k-1,2) + x_adjs[j], c(cfij$lo[k],cfij$hi[k]), col = cols[j])
  }
}
if(i > 2){
axis(1, at = 0:2, labels = c("B","A1","A2"))
}else{
 axis(1, at = 0:2, labels = c("","",""))
  }
axis(2, las = 1); 
box(bty = "l")
title(main = paste0(LETTERS[i],"."), adj = 0)
}
par(mar = c(0,0,0,0))
plot.new()
legend("center", pch = 16, col = cols, 
       legend = c("Control, 32% EI", "Impact 32% EI","Control 4% EI", "Impact 4% EI"),
       cex =1)
```

## Discussion

Proposed themes from working abstract:

1.  Increased heterogeneity only favours those taxa able to tolerate larger scale environmental filters that limit assemblage composition of highly disturbed ecosystems such as streams of urban catchments. (27)

2.  Riffle construction in streams of urban catchments is unlikely to have biodiversity benefits unless the limiting impacts (most likely urban stormwater runoff in areas sewage is well managed) are addressed first. (31)

And the following are 20-year old notes on preliminary results of habitat experiment that might be worth revisiting (from HE prelim findings.doc). Otherwise, the discussion has not yest been started!

1\. Physical effects of riffle structures.

In all streams, the smallest rocks (a few cm larger than the minimum size calculated by the method of Newbury and Gaboury) in each structure remained in place over one year. None of the structures have been outflanked. In all cases, the structures have resulted in a deeper pool upstream, and increased hydraulic diversity among the emplaced rocks. Some changes in sedimentation patterns have been evident in most cases, with increased loads of fine sediment upstream in all cases, and in some cases, downstream of and within the riffle also (see below).

2\. Differences between treatments

I think there will be little or no difference evident between the large-rock and graded-rock treatments. This may be a result of the actual differences in rock size between the two treatments not being as great as originally envisioned. Also, although it was intended that the large rock treatment would not alter the slope, some damming behind the structure was inevitable. Hydraulic changes due to each treatment type were therefore quite similar.

3\. Direct effects of rock emplacement

The fauna colonising the emplaced rocks were, in all cases, different from the fauna of the channel prior to placement. Tubificid and lumbriculid worms tended to dominate the pre-treatment substrata. Chironomid larvae (mainly Cricotopus and Chironomus) were more abundant among the emplaced rocks in Blind Creek. Simuliid larvae (mainly Simulium ornatipes) were more abundant on the emplaced rocks in the faster flowing (and better WQ) Olinda Creek. Differences among the emplaced rocks were less pronounced in Scotchmans Creek, probably as a result of sedimentation.

Although the assemblage structure changed with the addition of rocks, species richness in the section to which rocks were added tended to be lower after the rock emplacement than before.

4\. Wider reach effects of riffle structures

The following conclusions require confirmation with the full dataset (it is really too early to be publishing this).

Algal biomass increased (not necessarily just in the riffle itself) after emplacement.

Fauna typical of slower flowing waters tended to occur more commonly.

Although the overall species richness of each reach tended not to change, in at least one creek (Scotchmans) some species that were rare prior to emplacement were more common after, thus increasing per sample richness. No such change was evident in Blind Creek, where it is assumed poor WQ remains the limiting factor.

Taxa indicative of good water quality were absent or rare both before and after emplacement.

Temporal trends differed between streams. In Scotchmans, overall species richness declined in the November after emplacement, but rose to pre-emplacement levels by January (Colonization effect?) (Total abundances were higher on both after occasions than before). In Olinda, total abundance and species richness increased in the November after emplacement, but declined dramatically by January, presumably due to high levels of siltation.

5\. Conclusions.

The effects of riffle emplacement in urban streams on community structure tend to be small and variable. Smallest effects were obtained in streams with the poorest WQ.

The likely efficacy of habitat restoration measures can probably be assessed by an a priori assessment of water quality of the stream in question. This study will hopefully be able to provide an guide as to the likely changes to community structure, based on existing community structure.

Deleterious effects are possible if the stream carries high silt loads and the structure acts as a silt trap.

## Acknowledgements

Graham Rooney, Scott Seymour for funding the works and Neil Craigie who designed and built the riffles (memory-jog needed). 

Field and lab assistants (from lab and field notes): Jim Longworth, Elaine Bayes, Jason Sonneman, Andrew Sharpe, Claire Sellens, Sue Witteveen, Melissa Aalbers, Rhys Coleman, John Gooderham, Jessica Miller, Edward Tsyrlin, Kristy ?.

CRC for Freshwater Ecology and Melbourne Water for funding the research.

## References
