---
title: "Constructed rock riffles increase habitat heterogeneity but not biodiversity in streams constrained by catchment urban impacts"
author: "Christopher J Walsh, J Angus Webb, Daniel C Gwinn, and Peter F Breen."
format: docx
editor: visual
editor_options: 
  chunk_output_type: inline
bibliography: references.bib
csl: journal-of-applied-ecology.csl
---

```{r}
#| echo: false
#| message: false
#| error: false
#| include: false

source("misc_functions.R") # for ct function

# load misc data files from OSF
# library(osfr); library(dplyr); library(rgeos); library(sf); library(prettymapr)
# library(rbbt)

## Packages required for code to run
requiredPackages <- c("osfr","dplyr","readxl","rio","flextable","ftExtra","rgdal",
                      "sf","prettymapr","terra","RColorBrewer","scales","glue")
lapply(requiredPackages, require, character.only = TRUE, quietly = TRUE)

## Check if there is a 'data' directory. If not make one
if(!"data" %in% dir()){dir.create("data")}
## While in review, the 3 large data files are in a private OSF repository
## They can be downloaded to the data directory using this view-only link
## https://osf.io/cms84/?view_only=256efadc4a124bcb96c6483226ef3a23
## When the repository is public, the following will allow automatic download
# ## The following checks for large data files, and if absent downloads them 
# ## from the OSF repository to the data directory
# if(!"wq_data_compiled.xlsx" %in% dir("data")){
# wq_files <- osf_retrieve_node("cms84") %>% osf_ls_files()
# osf_download(wq_files, path = "data")
# }

# Load observed data as in S3
dat_list <- rio::import_list("data/urban_riffle_experiment_data_for_model.xlsx")
list2env(dat_list,globalenv())
sites <- sf::st_as_sf(sites, coords = c("mgae","mgan"), crs = 28355)

samples$seg <- substr(samples$old_samplecode,nchar(samples$old_samplecode)-1,
                      nchar(samples$old_samplecode)-1)
# The dataset contains samples from the segments upstream and downstream of the 
# riffle (putative or real) in each site for trip 1-4 (out of 6).  Given the 
# small effects in the 'riffle' segments (M), theu U and L segments were not 
# included in the analysis.
samples <- samples[samples$seg == "M",]
# Reduce biota table to match reduced samples table
biota <- biota[biota$smpcode %in% samples$smpcode,]
# Convert long-form biota table into a wide taxon-by-sample table of counts 
# in subsamples
biota_ct <- as.data.frame(ct(biota$smpcode, biota$shortcode, biota$count))
biota_ct <- biota_ct[match(samples$smpcode,row.names(biota_ct)),]
# Create a table of the same dimensions as biota_ct, with the subsample proportion
# for each observation (for coarsepick specimens, subsample ppn = 1)
ss_ct <- biota_ct
for(i in 1:nrow(samples)){
  ss_ct[i,] <- samples$subsample_perc[i]/100
}
for(i in which(biota$coarsepick == 1)){
  ss_ct[row.names(ss_ct) == biota$smpcode[i], biota$shortcode[i]] <- 1
}

# Assemble random predictors (site_no, sample_no, t)
sites <- sites[order(sites$exp_treatment,sites$ai),]
sites$site_no <- 1:nrow(sites)
samples$site_no <- sites$site_no[match(samples$sitecode,sites$sitecode)]
samples$sample <- substr(samples$old_samplecode,1,nchar(samples$old_samplecode)-1)
sample_nos <- data.frame(sample = unique(samples$sample))
sample_nos$sample_no <- 1:nrow(sample_nos)
samples$sample_no <- sample_nos$sample_no[match(samples$sample, sample_nos$sample)]
samples$t <- as.numeric(substr(samples$old_samplecode, 1,1))

# Assemble fixed predictors (a1,a2, ci, ba1ci, ba2ci, i, ba1cii, ba2cii, spring) into a matrix, u
samples$ba <- as.numeric(as.numeric(substr(samples$old_samplecode,1,1)) %in% c(3,4)) 
samples$ba[as.numeric(as.numeric(substr(samples$old_samplecode,1,1))) %in% c(5,6)] <- 2
samples$ba <- factor(samples$ba)
# a1 and a2 are the two after periods treated as categories with b as a reference
samples$ci <- as.numeric(sites$exp_treatment[match(samples$sitecode,sites$sitecode)] == "riffle") 
# 0 = control, 1 = riffle
samples$ai <- sites$ai[match(samples$sitecode, sites$sitecode)]
i_scaled <- scale(log10(samples$ai*100 + 0.1))
samples$i <- as.vector(i_scaled)
samples$spring <- as.integer(substr(samples$old_samplecode,1,1) %in% c(1,3,5))
u <- model.matrix(~ ba + ci + ba:ci + i + ba:ci:i + spring, data = samples)

# Data list for Stan
sdata <- list(n_obs = nrow(biota_ct),
              n_taxa = ncol(biota_ct),
              n_site = nrow(sites),
              n_sample = nrow(sample_nos),
              n_pred = ncol(u),
              n_t = max(samples$t),
              site_no = samples$site_no,
              samp_no = samples$sample_no,
              t = samples$t,
              u = u,
              c = as.matrix(biota_ct),
              s = as.matrix(ss_ct)
)

# load object oe_stats from urban_riffle_exp_S3.qmd, chunk calc_abundance_fits
oe_stats <- read.csv("small_data/riffle_baci_oe_stats.csv")
# load object pa_stats from urban_riffle_exp_S3.qmd, chunk fig-nbinom_pa_stats
pa_stats <- read.csv("small_data/riffle_baci_pa_stats.csv")
```

## Abstract

1.  Riffles are heterogeneous habitats that support diverse assemblages in natural streams. Rock riffles are often constructed as part of stream restoration practice, including in degraded urban stream ecosystems despite larger-scale limits to ecological state. Effective restoration practice requires robust evidence of instream biotic responses to management actions. (48)

2.  We assessed the effects of constructed rock riffles on habitat heterogeneity and on macroinvertebrate assemblages in 6 urban streams (4--32% effective imperviousness), comparing taxon abundance and richness in study reaches before and after (1-y and 5-y after) between the 6 reaches and 3 control reaches without riffles. (48)

3.  Riffles increased habitat heterogeneity. Macroinvertebrate assemblages in all streams were dominated by tolerant, cosmopolitan and invasive taxa before and after riffle construction. Riffles reduced the abundance and richness of tolerant taxa in less urban streams and increased their richness in more urban streams. These changes had no effect on measures of biodiversity. (53)

4.  Urban stormwater runoff can affect the degree to which rock riffles increase habitat heterogeneity through sediment transport and increased physical disturbance. In highly urban streams, increased habitat heterogeneity is likely to primarily favour cosmopolitan species that can tolerate frequent chemical and physical disturbance. (44)

5.  Riffle construction may reduce abundance of cosmopolitan species and increase abundance of more sensitive species, but only if catchment-scale impacts of urban stormwater runoff are adequately controlled. (28)

## Introduction

Most rivers and streams of agricultural and urban landscapes are ecologically degraded [@allan_2004; @walsh_etal_2005]. A common contributor to their degradation is channelization; straightening and grading of the channel to remove heterogeneous channel elements such as riffle-pool sequences and meanders [@brookes_1994]. In urban catchments in particular, the altered flow regime and increased volumes of runoff makes stream channels deeper, wider and simpler [@vietz_etal_2016], and these morphologic changes in turn have often contributed to decisions to channelize or concrete urban streams, or convert them to underground pipes [@brookes_1994; @elmore_kaushal_2008].

Despite channel simplification and channelization usually being driven by catchment-scale changes to flow and sediment dynamics, the most common stream management response to addressing dissatisfaction with engineered channels remains re-engineering channels to accommodate altered flow and sediment regimes [@palmer_etal_2014a]. The objectives for such engineering projects can be diverse, but commonly include provision of habitat for stream flora and fauna [e.g. @wild_etal_2011; @melbournewater_2019]. In the absence of other limitations, restoring stuctural heterogeneity to simplified stream channels should, in theory, permit colonization by a greater diversity and abundance of in-stream species by permitting greater niche partitioning [@willis_etal_2005] or providing refugia from disturbance or predation [@dean_connell_1987]. However, where the simplified channel has resulted from changes to flow and sediment dynamics, biotic response to channel engineering is likely to be limited by larger-scale factors [@bernhardt_palmer_2011].

Re-introduction of riffle-pool sequences is a common element of channel engineering projects [@palmer_etal_2010]. Rock riffles in particular, by providing shallower, faster and more variable flow conditions than channelized runs, add heterogeneity to simplified channels at the reach scale. Within riffles, more variable flow, depth and substrate can provide habitat variability for stream invertebrates [e.g. @statzner_etal_1988] and fish [e.g. @kessler_thorp_1993]. Emergent rocks, which are common features of riffles, can be important sites for oviposition of many insect species with stream-dependent larvae [@lancaster_etal_2010].

However, observed biotic responses to restoration of habitat heterogeneity in rivers and streams have varied. @palmer_etal_2010 and @palmer_etal_2014a, in reviewing published studies of biotic response, concluded that recovery of diversity following addition of in-stream habitat was rare. A more quantitative assessment of responses in diversity and abundance of macroinvertebrates by @miller_etal_2010 inferred a more consistent recovery response, but importantly identified that the size and certainty of response was greatest in streams of forested catchments, with response much less likely in streams of urban catchments. This conclusion is consistent with subsequent studies of stream restoration in urban catchments [e.g. @sudduth2011; @violin_etal_2011] that pointed to the overriding influence of catchment-scale impacts, which are likely to limit the effects of small-scale morphological change, particularly in urban catchments [@bernhardt_palmer_2011]. Despite these conclusions a decade ago, channel engineering and 'daylighting' of buried streams in urban catchments with an objective of providing habitat for stream biota remain popular endeavours [@scoggins_etal_2022; @melbournewater_2019; @delibas_tezer_2017].

@rubin_etal_2017 critiqued the reviews of @palmer_etal_2010 and @miller_etal_2010, noting that only a minority of the studies considered were robustly designed: e.g. with before-after monitoring (and very few with \>1 y after monitoring); or with comparisons between restored and control or reference sites; or with assessment of the degree of change in heterogeneity. They also pointed to the limitations of simple metrics of richness and diversity as criteria for restoration success. Growing public interest in restoring urban stream corridors [@scoggins_etal_2022] strengthens the need for robust evidence of likely effects of channel engineering projects on urban instream biota, to inform expectations and prioritization of the diverse objectives and management actions that might be part of such projects [e.g. @usher_etal_2021].

We aim to provide robust evidence that in-stream biotic assemblages are little affected by increased in-stream habitat heterogeneity, if they are limited by catchment-scale urban impacts. We report on a replicated before-after-control-impact (BACI) experiment of the effects of constructed riffles in simplified streams of urban catchments spanning low to moderate urban density. We compare 6 experimental reaches in which riffles were constructed with 3 control reaches without riffles, measuring densities of macroinvertebrate taxa twice before riffle construction, twice in the first year after, and twice 5-6 years after. We use a hierarchical multi-taxon model to assess changes in the abundance of taxa resulting from the riffles, thus providing a rich description of assemblage response accounting for taxon identity [@ovaskainen_etal_2017], while also assessing changes in richness and biotic metrics more typically used to assess responses to channel change. The experimental addition of riffles to the simplified channels adds reach-scale heterogeneity to the channel by creating a new habitat type absent in the before state and in control sites: we assess the extent of the increased heterogeneity by measuring variation in depth, velocity and substrate at the scale at which invertebrates were sampled.

## Methods

### Study area and experimental design

The experiment was a BACI study with the 'impact' being the construction of rock riffles in degraded urban streams. We selected sites on nine streams draining separate catchments in the eastern suburbs of Melbourne, Victoria, Australia (@fig-experiment_map), and randomly allocated six as 'impact' sites in which riffles were constructed, and three as 'control' sites. All sites were sampled twice in the year before riffle construction, and twice in each of two 'after' periods: *A1* in the first year and *A2*, 5 and 6 years after riffle construction. We inferred effects of the riffles from the interactions between the before-after and control-impact effects: short-term effects using the before-*A1* difference and long-term effects using the before-*A2* difference.

The streams' catchments all included conventionally drained [sensu @burns_etal_2012] urban land with effective imperviousness (EI) ranging from 4 to 32% (@fig-experiment_map : total imperviousness ranged from 10-45% see Table S1-1). EI was estimated from 2004 imagery [@grace_gis_2012]: there was little urban growth since the study began. We further assessed if the effects of riffles differed with degree of urbanization by assessing the three-way interactions between before-after (both *A1* and *A2*), control-impact and EI.

Nine candidate sites were selected from low-gradient, channelized (or at least straight), incised reaches, with little or no riparian vegetation, and no differentiation of riffle or pool, in the sedimentary marine and alluvial deposits of Melbourne's eastern suburbs. Reaches needed to be long enough to encompass a pool-riffle-pool sequence in a restored channel. We surveyed the 9 sites to estimate tractive force in each channel, and to select the most suitable section of the reach for each riffle (which was sampled for macroinvertebrates before and after riffle construction). We consulted with an engineer who designed and supervised the construction of riffles in these segments on the six 'impact' streams in May 1996. The riffles were 9--22-m long, with 4:1 upstream and 40:1 downstream slopes, and made of angular rocks with mean diameters 15--40 cm (Appendix S1). The original study design called for two rock-size treatments [graded and large: @walsh_breen_2001], but the grade of rocks delivered did not differ strongly between sites, and are considered a single treatment in this analysis. The minimum diameter was larger than the diameter of material at incipient motion for all streams, based on calculations of tractive force from the reach surveys. This riffle design is typical of river management practice in Melbourne's urban streams [@melbournewater_2019]. The sampled segments were left unchanged in the three control streams, but it is noteworthy that by the mid 2000s, management authorities had constructed similar rock riffles on the sampled segments of two of the control reaches.

```{r}
#| label: fig-experiment_map
#| echo: false
#| fig-width: 5
#| fig-height: 6.5
#| warning: false
#| message: false
#| fig-cap: "Map of experimental sites (6 sites in which riffles were constructed and 3 control sites) and their catchments. The extent of impervious coverage (in 2004, gray basemap), piped sections of streams (dark grey stream lines), and the percentage effective imperviousness of each catchment indicate the range of urban impacts among the sites."

streams <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "streams", quiet = TRUE)
pipes <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "pipes", quiet = TRUE)
cats <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "cats", quiet = TRUE)
coast <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "coast", quiet = TRUE)
victoria <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "victoria", quiet = TRUE)
australia <- sf::st_read("data/urban_riffle_experiment_map.gpkg", layer = "australia", quiet = TRUE)
ia <- terra::rast("data/ia_5m_raster.tif")
#Colour sites by experimental treatment (see: https://colorbrewer2.org/)
sites$col <- 
  RColorBrewer::brewer.pal(3,"Dark2")[match(sites$exp_treatment == "riffle",0:1)]
sites$reach <- substr(sites$sitecode, 1, nchar(sites$sitecode) - 1)

layout(matrix(c(1,2,1,3,1,4,1,5),4,2,byrow = TRUE), 
       widths = c(10,2.5), heights = c(8,8,4,4))
par(mar = c(0,0,0,0))
plot(cats$geom, pch = 21, border = "white")
terra::plot(ia, col = gray(0.5), legend = FALSE, axes = FALSE, add = TRUE)
plot(cats$geom, border = sites$col[match(cats$reach,sites$reach)], 
     col = scales::alpha(sites$col[match(cats$reach,sites$reach)],0.25),
     lwd = 2, add = TRUE)
plot(streams$geom, col = "dodgerblue", add = TRUE)
plot(pipes$geom, col = gray(0.25), add = TRUE)
# # Function to find optimal point for polygon label. Result saved because
# # rgeos is being retired in 2023
# x <- rgeos::polygonsLabel(as_Spatial(cats), doPlot = FALSE)
# x <- data.frame(sitecode = sites$sitecode[match(cats$site,sites$site)],
#                 ei_label = 
#                   paste0(round(100*sites$ai[match(cats$site,sites$site)]),"%"),
#                 mgae = x[,1], mgan = x[,2])
# write.csv(x, "small_data/cat_polygon_label_points.csv",row.names = FALSE)
labels <- read.csv("small_data/cat_polygon_label_points.csv")
text(labels$mgae, labels$mgan, labels$ei_label, font = 2)
plot(coast$geom, lwd = 2, add = TRUE)
plot(sites$geometry, pch = 21, bg = sites$col, add = TRUE) # so that the sites are on top
rng <- par('usr')
suppressWarnings(
prettymapr::addscalebar(pos = "bottomright", label.cex = 1, plotepsg = 28355))
box(lwd=2)
rngPoly <- st_sfc(st_polygon(list(rbind(rng[c(1,3)], rng[c(1,4)], rng[c(2,4)], 
                                 rng[c(2,3)],rng[c(1,3)]))))
rngPoly <- st_sf(a = 1, geom = rngPoly)
# Legends
plot.new()
legend("center", pch = c(21,21,15), pt.cex = c(1,1,2), 
       pt.bg = c(RColorBrewer::brewer.pal(3,"Dark2"),NA),
       col = c("black","black",gray(0.5)),
       legend = c("Control","Riffle","Impervious"),bty = "n")
box()
plot.new()
legend("center", lty = 1, col = c("dodgerblue",gray(0.25)),
       legend = c("Stream","Piped stream"),bty = "n")
box()
# Location maps
st_crs(rngPoly) <- 28355
rngPoly <- rngPoly %>% st_transform(4283)
par(mai = c(0.028,0.028,0.028,0.028) * 0)
plot(australia$geom)
plot(victoria$geom, col = "white", add = TRUE)
polygon(c(142.9651,146.5656,146.5656,142.9651),c(-39.1122,-39.1122,-36.4374,-36.4374), col = scales::alpha(gray(0.5),0.5))
plot(rngPoly$geom, col = "black", add = TRUE)
title(main = "Australia", adj = 0, 
      font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
bounds <- st_sfc(st_point(c(143.5,-36.5)), st_point(c(146.5,-39.1)),crs=4283)
plot(bounds, col = "white")
plot(victoria$geom, add = TRUE)
rng_vic <- par("usr")
plot(rngPoly$geom, col = scales::alpha(gray(0.5),0.5), add = TRUE)
title(main = "Central Victoria ", 
      adj = 1, font.main = 1, line = -1, cex.main = 1)
box(lwd = 1)
```

### Macroinvertebrate assemblage sampling and identification

Data were collected at the nine sites on six occasions; twice prior to the installation of riffles (Nov 1995, Feb 1996), and four times after riffle installation (Nov 1996, Feb 1997, Dec 1999, Feb 2001). On each occasion, we collected replicate macroinvertebrate sample units (4 on occasions 1-4, 3 in Dec 1999 and Feb 2001) at each site using a 0.04 m^2^ suction sampler [@boulton_1985]. To take a sample, one operator disturbed sediments in the sample quadrat with a spatula and scrubbed larger surfaces with a small brush while the second operator pumped out the sampler contents into a 250 $\mu$m net.

We processed sample units separately, and considered the set of replicates collected from each site on each occasion a sample. Each sample unit was preserved in 2% formaldehyde. In the laboratory, many sample-units were subsampled to reduce processing time. Initially, some samples were fully processed to develop the subsampling protocol reported by [@walsh_1997], which was followed in processing all subsequent samples. The protocol requires a 10% subsample to be sorted, followed, if necessary, by additional subsamples until 300 specimens have been collected. Trends in subsample proportions over the 6 sampling periods differed among the study sites, potentially leading to differing biases in abundance estimates over time and among sites [@buonaccorsi_2010; @kery_schaub_2011]. We thus accounted for subsampling error in our statistical models (see below). Macroinvertebrates were identified to lowest practicable taxonomic level and counted (See Appendix S2 for more detail).

### Environmental variable determination

After each sample unit was collected, the sampler was removed from the stream bed, and water depth and velocity at the bed surface were measured at the four corners of the sampled area and the centre point. We measured velocity with a CMC 20 current meter counter, fitted with a 1-94.22 propeller, for 10 s at each point, 4 cm above the bottom (the lowest possible setting). From these five measurements, we calculated the mean and variance of velocity for each sample unit.

We noted the proportions, using Braun-Blanquet classes, of sediment particle sizes classed by the Wentworth scale [@allan_etal_2021], and used these data to estimate minimum, median, and maximum $\Phi$ (-log~2~ smallest diameter) of the sediments in each sample unit.

We compiled these data into 6 environmental variables to assess the effect of riffles on habitat heterogeneity at the scale of sample units: mean velocity, variance of velocity, mean depth, variance of depth, and minimum and median $\Phi$ (the latter showed similar results to maximum $\Phi$).

### Statistical models

We used a similar model structure to assess the effect of the riffles on environmental variables, and on the abundances of macroinvertebrate taxa collected in each sample unit. In all cases, the effects of primary interest were the interaction between the before-after effect (*BA*) and the control-impact effect (*CI*), and the three way interaction between BA, CI and (transformed and scaled) catchment EI, which indicate an effect observed after riffle construction in impact sites that was not observed in control sites.

The environmental variables, except $\Phi$, were log-transformed (see Table 1 S3). In each case, we modeled the resulting variable in each sample unit $y_i$ as a normal distribution. Thus:

$$
y_i \sim \textrm{Normal}(\mu_i, \sigma)
$$ {#eq-env_var_likelihood}

where $\mu_i$ is the mean value of the variable in sample unit, *i*, and $\sigma$ is the standard deviation.

We modeled $\mu_{i}$ as a function of 3 random predictors accounting for the error structure of the dataset and 9 fixed predictors comprising *I* (scaled, log(x + 0.1) % catchment EI), and combinations of 5 binary variables that characterise the *BA* and *CI* effects: *B* (= 1 for samples taken before riffle construction), *A1* (samples taken in first year after construction), *A2* (samples taken 5--6 y after construction), *C* (samples from control sites) and *R* (samples from 'impact' sites in which riffles were constructed). Thus:

$$
\begin{align}
\mu_{(i)} = \ &\alpha + \beta_1 \cdot I_i + \beta_2 \cdot A1_i + \beta_3 \cdot A2_i + \beta_4 \cdot R_i +\\
& \beta_5 \cdot A1_i \cdot R_i +  \beta_6 \cdot A2_i \cdot R_i +\\
& \beta_7 \cdot B_i \cdot R_i \cdot I_i +  \beta_8 \cdot A1_i \cdot R_i \cdot I_i +  \beta_9 \cdot A2_i \cdot R_i \cdot I_i + \\
& \theta_{1(s[i])} + \theta_{2(t[i])} + \theta_{3(s[i],t[i])}
\end{align}
$$ {#eq-env_var_linear_model}

where $\alpha$ is the model intercept (*B* = 1 and *C* = 1 and *I* = 0), $\beta_{1-4}$ are coefficients of the main *I*, *BA* and *CI* effects, $\beta_{5-6}$ are coefficients of two-way interactions between *BA* and *CI* effects, and $\beta_{7-9}$ are coefficients of the three-way interactions between *BA*, *CI*, and *I*. The $\theta$ parameters model the error structure of the data. $\theta_{1(s[i])}$ models variation among samples within each site, indexed by *s*\[*i*\], i.e. the site number (1--9) for observation (sample unit) *i*. $\theta_{2(t[i])}$ models variation among samples within each sampling campaign (1--6), indexed by *t*\[*i*\]. $\theta_{3(i,s[i],t[i])}$ models variation among the four sample units within each sample, indexed by the combinations of *s* and *t*.

We modeled the total count of taxon *j* in each sample unit, *i*, ($Y_{i,j}$) as a negative binomial distribution (given the highly skewed distributions of taxon counts) and the count of taxon *j*, ($c_{i,j}$), in a subsample of sample unit *i* as a binomial distribution given the subsample proportion $s_{i,j}$ and $Y_{i,j}$. Thus:

$$
\begin{align}
&Y_{i,j} \sim \textrm{Neg. Binomial}(\mu_{i,j}, \phi_{j}) \\
\\
&c_{i,j} \sim \textrm{Binomial}(s_{i,j}, Y_{i,j})
\end{align}
$$ {#eq-multi_taxon_count_likelihood}

where $\mu_{i,j}$ = the mean total count of taxon *j* in sample unit *i*, and $\phi_j$ = the dispersion parameter of the negative binomial distribution for taxon *j*.

We modeled $\mu_{i,j}$ as a linear model with similar structure to @eq-env_var_linear_model, with an additional predictor, season (*S*: autumn = 0, spring = 1), to account for seasonal differences in macroinvertebrate abundances, and with estimates of all coefficients for every taxon thus:

$$
\begin{align}
\mu_{(i,j)} = \ &\alpha_j + \beta_{1(j)} \cdot I_i + \beta_{10(j)} \cdot S_i + \beta_{2(j)} \cdot A1_i + \beta_{3(j)} \cdot A2_i + \beta_{4(j)} \cdot R_i +\\
& \beta_{5(j)} \cdot A1_i \cdot R_i +  \beta_{6(j)} \cdot A2_i \cdot R_i +\\
& \beta_{7(j)} \cdot B_i \cdot R_i \cdot I_i +  \beta_{8(j)} \cdot A1_i \cdot R_i \cdot I_i +  \beta_{9(j)} \cdot A2_i \cdot R_i \cdot I_i + \\
& \theta_{1(s[i],j)} + \theta_{2(t[i],j)} + \theta_{3(s[i],t[i],j)}
\end{align}
$$ {#eq-multi_taxon_linear_model}

where $\alpha_j$ and $\beta_{1-9(j)}$ are as described for the environmental variable model, but with a separate value for each taxon *j*, and $\beta_{10(j)}$ is the coefficient for season, *S*. $\theta_{1(s[i],j)}$, $\theta_{2(t[i],j)}$, and $\theta_{2(s[i],t[i],j)}$ are as described for the environmental variable model, with a separate value for each taxon *j*.

All $\beta$ parameters were formulated as random effects drawn from community-level hyper-distributions with the mean parameters specified as diffuse normal distributions (mean 0, sd 5) and the parameters for each species drawn from a multivariate normal distribution with a variance-covariance matrix that describes the residual associations among species.

Prior distributions for the random effect parameters for site ($\theta_{s}$), sampling occasion ($\theta_{t}$)and sample ($\theta_{st}$) were normal, with mean 0 and sds drawn from normally distributed hyper-distributions among sites, sample occasions, and all combinations of sites and occasions, respectively, (mean 0, sd with a half-normal prior distribution: mean 0, sd 1). For the multi-taxon model, the dispersion parameter ($\phi$) of the negative binomial distribution for each taxon both had a weakly informative normal prior distributions (mean 1, sd 1, restricted to values \> 1). We derived the models using the Markov chain Monte Carlo sampler of Stan [@carpenter_etal_2017]. All models satisfied tests for convergence, effective sample size, and Bayesian Fraction of Missing Information (@stan_dev_team_2022: see Appendix S3 for more details).

We quantified model accuracy and bias by correlation coefficients, *R*, between observed and predicted abundances (of environmental variables and of abundances of each taxon) in each sample. To assess potential bias in model predictions, we calculated the slope of a regression of predicted abundance as a function of observed abundance. We also assessed the accuracy of predictions of taxon occurrence by the area under the operator curve (AUC) of logistic regressions of predicted probability of occurrence as a function of observed presence or absence each taxon in each sample (see below). Finally we assessed the accuracy of multi-taxon model predictions of number of taxa in each sample (total and number of Ephemeroptera, Plecoptera and Trichoptera---EPT---taxa), assessing the *R^2^* of regressions between predicted and observed, accounting for subsample proportion.

The environmental variables were all well predicted by their respective models (observed:predicted *R* \> 0.9, slope \> 0.9 and \<1 for all models). The multi-taxon model predicted abundances of all taxa at each site well (mean R for all taxa `r round(mean(oe_stats$cor),2)` (range `r round(min(oe_stats$cor),2)`--`r format(round(max(oe_stats$cor),2), nsmall = 2)`), without bias for the `r sum(oe_stats$slope > 0.8)` taxa (mean slope `r round(mean(oe_stats$slope[oe_stats$slope > 0.8]),2)`, range `r round(min(oe_stats$slope[oe_stats$slope > 0.8]),2)`--`r round(max(oe_stats$slope[oe_stats$slope > 0.8]),2)`). Abundances of `r sum(oe_stats$slope <= 0.8)` taxa with lower prevalence and abundance tended to be underestimated (mean slope `r round(mean(oe_stats$slope[oe_stats$slope <= 0.8]),2)`). However, the occurrences of all taxa were well predicted by the model (AUC \> `r format(round(min(pa_stats$AUC, na.rm = TRUE),2),nsmall = 2)`), and the sums of predicted probabilities of occurrence predicted numbers of taxa per sample well. The regression of predicted number of taxa as a function of observed had *R^2^* = 0.57, with predicted number of taxa being greater than observed for samples with few observed taxa. However, this was likely because most such samples had smaller subsample fractions than more taxa-rich samples. The regression of predicted as a function of observed + subsample proportion had a higher *R^2^* (0.64). Numbers of EPT taxa were well predicted by the model (*R^2^* = 0.88), with a smaller effect of subsample size. See Appendix S3 for more detail. The good fit of the model predictions to the data provides confidence in inferences of the *BA*, *CI* and *I* effects, which are the focus of this study.

### Model interpretation

To interpret interactions between the effects of riffle construction and degree of catchment urbanization, we derived posterior predicted distributions of abundances of taxa for which the interactions of interest were non-zero with at least 90% confidence for 12 scenarios. The scenarios comprised four site types (control and impact sites with high and low effective imperviousness (4% and 32% EI, the maximum and mimimum EI values in the study sites, respectively), in the three states of the BA effect (*B*, before; *A1*, in the first year after riffle construction; and *A2*, 5-6 years after).

We focused first on taxa for which the *BA:CI* or *BA:CI:I interactions* were non-zero with at least 90% confidence to understand which taxa drove assemblage-level differences. We also derived predictions of responses of assemblage-level metrics from the model for each of the 12 scenarios. Responses of diversity measures such as richness are of intrinsic community ecological interest, but they and biotic metrics focussing on taxa of differing sensitivity to human disturbance are used by stream managers as measures of ecological condition and targets for responses to management actions [e.g. @vic_gov_2018]. We used predicted abundances and occurrences for each scenario to calculate posterior distributions of:

-   Total macroinvertebrate abundance, of EPT taxa [insect orders dominated by taxa sensitive to human disturbance, @resh_jackson_1993], and of Diptera and Oligochaeta [QDLO, groups dominated by taxa tolerant to human disturbance; @gooderham_tsyrlin_2002; @martin_etal_2008];

-   Total taxon richness (i.e. taxon density, the number per sample comprising 4 sample units), also EPT and QDLO richness;

-   Shannon's H' (i.e. the Shannon-Weaver index) and Pielou's evenness index, measures of diversity accounting for relative abundance of taxa;

-   SIGNAL, a biotic index which averages grades of sensitivity to human disturbance (between 1 and 10) of families present in a sample [@chessman_1995].

Abundance measures were calculated by adding predicted mean abundances per sample unit of the relevant taxa. Richness measures were derived by first calculating predicted probability of occurrence in a sample,

$$
p\_s = 1 - \Pi(1 - p\_{su}_i)
$$ {#eq-predict_pa}

where $p\_su_i$ is the probability of occurrence in the *i*th sample unit comprising the sample, calculated as 1 - negative-binomial probabliity of zero, given predicted $\mu$ and $\phi$. Number of taxa in each sample was calculated as the sum of probabilities of occurrence (see Appendix S3 for more detail).

To assess the probability of an effect of riffle construction on environmental variables, assemblage metrics and taxon abundances, we calculated the following four differences between the posterior distributions of metrics and abundances given the 12 scenarios:

-   $\Delta A1 \, (\textrm{4%} \, EI)$, (control minus impact before, *B*) - (control minus impact in first year after, *A1*) for low *I*

-   $\Delta A2 \, (\textrm{4%} \, EI)$, (control minus impact before, *B*) - (control minus impact 5-6 y after, *A2*) for low *I*

-   $\Delta A1 \, (\textrm{32%} \, EI)$, (control minus impact before, *B*) - (control minus impact in first year after, *A1*) for high *I*

-   $\Delta A2 \, (\textrm{32%} \, EI)$, (control minus impact before, *B*) - (control minus impact 5-6 y after, *A2*) for high *I*

We inferred a likely effect of riffle construction on each measure if \>90% of the posterior distribution of any one of the differences was greater than zero (indicating that the measure in impact sites increased relative to control sites following riffle construction) or less than zero (indicating a decline in impact sites relative to control sites).

## Results

### Responses of environmental variables

The constructed riffles altered the available substrates in the study reaches, increasing surface and hydraulic heterogeneity.

Riffles resulted in shallower water through the reach (@fig-cf_env_vars C, D, although no change in variability in depth at the sample-unit scale: @fig-cf_env_vars A, B), and increased mean velocity, and variance of velocity (@fig-cf_env_vars E-H), indicating increased heterogeneity of the hydraulic environment.

Before riffle construction, and in control sites throughout the study, median $\Phi$ before was 1 to 6 (sand to clay). Riffles reduced median $\Phi$ to -6 to -7 (small to large cobbles) in sites with low EI, and this change persisted for 6 years (A2, @fig-cf_env_vars L). In sites with high EI, riffles had a smaller effect on median $\Phi$, reducing in the first year to -2 (gravel), but increasing to 1 (coarse sand) after 6 years, as sand deposited among the riffles (@fig-cf_env_vars K, L). The trends in maximum $\Phi$ (not reported) were similar to those of median $\Phi$.

Riffles more consistently reduced minimum $\Phi$ (i.e. introduced larger particles) to -6 to -7 in all impact sites. However, the effect of riffle construction on minimum $\Phi$ was small in sites with low EI, which contained some large pebbles before riffle construction (@fig-cf_env_vars I, J). An effect of the riffles not quantified by these measurements was an increase in the availability of large emergent rocks (See Appendix S1, Figures S1-2 to 10).

```{r}
#| label: fig-cf_env_vars
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 6
#| fig-cap: "Posterior distributions of the differences in abundance for the four contrasts illustrating the effect of riffle construction (A, C, E, G, I, K) and trends from before to after riffle construction (B, D, F, H, J, L) in 6 environmental variables. A, B. Mean water depth, C, D. Variance of water depth within each 0.04 m^2 sample unit, E, F, Mean velocity, G, H. Variance of velocity, I, J. Minimum $\\Phi$ (the negative log of diameter of sediment particles in the sample unit). K, L. Median $\\Phi$. For the distribution plots, 95th, 90th, and 75th percentiles are indicated by increasingly thick bars. Coefficients with >90% less than zero are red, and >90% greater than zero blue. The four lines in each trend plot connect mean (± 95% confidence intervals) metric values  before (B) and at two times after (A1, in the first year, and A2, 5-6 years later) construction of the experimental riffles for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI). (Note: depth and velocity plots are log-transformed: I still need to transform their axes."

# load cfs, list of 12 data frames (one for each environmental variable), with
# percentile statistics of posterior distributions for 60 counterfactual scenarios
# including the 12 plotted here
cfs <- rio::import_list("small_data/env_var_predy_cf.xlsx")
# Do not plot max_phi
cfs <- cfs[names(cfs) != "max_phi"]

# load env_diff_summs, a data.frame with the percentile statistics of posterior
# distributions of the four BACI contrasts for each of the 12 environmental variables
load("small_data/env_diff_summs.rda")
diffs <- c("delta_baci1_hi","delta_baci2_hi","delta_baci1_low","delta_baci2_low")
nms <- c( bquote(Delta~"A2 4% EI"), bquote(Delta~"A1 4% EI"), 
          bquote(Delta~"A2 32% EI"),bquote(Delta~"A1 32% EI"))
ylabs <- c("A2,4%EI","A1,4%EI","A2,32%EI","A1,32%EI")
ylabs1 = c("Variance of depth (cm)", "Mean depth (cm)","Variance of velocity (m/s)", 
          "Mean velocity (m/s)", "Minimum Phi","Median Phi")
# cols <- ggsci::pal_jco(palette = c("default"), alpha = 1)(4)
# spell them out so that they are displayed in Rstudio
cols <- c( "#CD534CFF","#EFC000FF","#868686FF","#0073C2FF")

layout(matrix(c(1:12,rep(13,4)),4,4,byrow=TRUE), widths = c(10,10,10,10),heights = c(10,10,10,2))
for(i in 1:6){
  panel_index <- which(1:6 == i)
# Difference distribution plot
  miny <- 0.5; maxy <- 4.5
  summp <- env_diff_summs[env_diff_summs$stat == names(cfs)[i],]
  summp <- summp[match(diffs,summp$diff),]
  par(mar = c(4,5,1,0))
  xrange <- c(min(summp$lo95),max(summp$hi95))
  plot(xrange,c(miny,maxy),type = 'n', axes = FALSE, xlab = "Difference",ylab = "")
  for(j in 1:4){
    lines(c(summp$lo95[j],summp$hi95[j]),rep(miny+maxy-j,2),lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    lines(c(summp$lo90[j],summp$hi90[j]),rep(miny+maxy-j,2), lwd = 2,lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    lines(c(summp$lo75[j],summp$hi75[j]),rep(miny+maxy-j,2), lwd = 4,lend = 2,
          col = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
    points(summp$mean[j],miny+maxy-j,pch = 21, 
           bg = ifelse(summp$hi90[j] < 0,"red",ifelse(summp$lo90[j] > 0, "blue","grey")))
  }
  axis(1); 
  axis(2, at = 1:4, labels = ylabs, las = 1) 
  box(bty = 'l')
  abline(v = 0, lty = 3)
  title(main = paste0(LETTERS[(panel_index-1)*2 + 1],". "), adj = 0)

# Trend plot
  cfi <- cfs[[i]]
  combos <- list(control_hii = which(cfi$ci == 0 & cfi$i == max(cfi$i)),
                 impact_hii = which(cfi$ci == 1 & cfi$i == max(cfi$i)),
                 control_lowi = which(cfi$ci == 0 & cfi$i == min(cfi$i)),
                 impact_lowi = which(cfi$ci == 1 & cfi$i == min(cfi$i)))
  x_adjs <- c(-0.03, -0.01, 0.01, 0.03)
  ylabi <- ylabs1[i]
  names(cfi)[match(c("mean","X2.5.","X97.5."),names(cfi))] <- c("pred","lo","hi")
  gofs <- read.csv("small_data/env_gofs.csv")
  gofs <- gofs[gofs$model != "max_phi",]
  cfi[c("pred","hi","lo")] <- unscale(cfi[c("pred","hi","lo")],
                                        x = as.numeric(samples[,gofs$model[i]]),
                                        scaled = TRUE,
                                        log = c(TRUE, TRUE, TRUE, TRUE, FALSE, FALSE)[i],
                                        log_add = c(1.75e-04,0,0.0007442,0,0,0)[i])$y_transformed
  cfi1 <- cfi[combos[[1]],]
       plot(0:2 + x_adjs[1], cfi1$pred, ylim = c(min(cfi$lo),max(cfi$hi)), 
            type = 'b', col = cols[1], pch = 16, axes = FALSE, xlim = c(0,2),
            xlab = "", ylab = ylabi)
  lines(0:2 + x_adjs[2], cfi$pred[combos[[2]]],
                                col = cols[2], pch = 16, type = 'b')
  lines(0:2 + x_adjs[3], cfi$pred[combos[[3]]],
                                col = cols[3], pch = 16, type = 'b')
  lines(0:2 + x_adjs[4], cfi$pred[combos[[4]]],
                                col = cols[4], pch = 16, type = 'b')
  for(k in 1:ifelse(grepl("_g",names(cfs)[i]), 2,3)){
    for(j in 1:4){
      cfij <- cfi[combos[[j]],]
      lines(rep(k-1,2) + x_adjs[j], c(cfij$lo[k],cfij$hi[k]), col = cols[j])
    }
  }
  axis(1, at = 0:2, labels = c("B","A1","A2"))
  axis(2, las = 1); 
  box(bty = "l")
  title(main = paste0(LETTERS[(panel_index-1)*2 + 2],"."), adj = 0)
}
  par(mar = c(0,0,0,0))
  plot.new()
  legend("center", pch = 16, col = cols, horiz = TRUE,
   legend = c("Control, 32% EI", "Impact, 32% EI", "Control 4% EI","Impact 4% EI"),
   cex = 1)

```

### Responses of macroinvertebrate taxa

```{r}
#| echo: false
#| label: tbl-top10taxa
#| tbl-cap: "Mean abundance (N per 0.04 $m^2$ sample unit) under the 12 scenarios of the 22 taxa that were among the 10 most abundant taxa in at least one scenario, and the percentage of the total count of all taxa in each scenario that the 19 taxa constitute.  Low and High I, 4% and 32% effective imperviousness, respectively; B, Before; A1, in the first year after; A2, 5-6 years after riffle construction. See Appendix S2 for explanation of Tubificinae taxa."

top10taxa <- read.csv("small_data/top10taxa.csv")
  ft <- flextable::regulartable(top10taxa[,-1])
  ft <- ftExtra::span_header(ft, sep = "_")
  ft <- flextable::align(ft, align = "center", part = "header")
  ft <- flextable::italic(ft, i = which(top10taxa$taxoncode %in% taxa$taxoncode[taxa$italic == 1]), j = 1)
  ft <- flextable::bold(ft, i = nrow(top10taxa))
  ft <- flextable::hline(ft, i = nrow(top10taxa)-1)
  ft <- flextable::font(ft,fontname = "Helvetica", part = "all")
  ft <- flextable::fontsize(ft, size = 10, part = "all")
  ft <- flextable::padding(ft, padding.top = 2,  padding.bottom = 2, part = "all")
  ft <- flextable::autofit(ft)
  ft <- flextable::width(ft, width = dim(ft)$widths*6.69 /(flextable_dim(ft)$widths))
ft
```

The macroinvertebrate assemblages of all sites were numerically dominated by cosmopolitan taxa, tolerant of human disturbance, although the most abundant taxa tended to be less abundant, and constituted a lower proportion of the assemblage, in sites with lower EI (Table 1). *Potamopyrgus antipodarum*, *Physa acuta*, *Lumbriculus variegatus*, and likely members of other taxa, are invasive species. Thus, despite the sites spanning a gradient of EI from 4 to 32%, the biota of all sites were dominated by taxa typical of degraded urban streams, and this general state was consistent across before and after periods, although (Table 1) suggests some reduction in the dominance of some cosmopolitan taxa after riffle construction in low EI impact sites.

```{r}
#| echo: false
#| warning: false
#| message: false

# Load summary statistics for the fixed parameters (created in predy_summary chunk in `urban_riffle_exp_S3.qmd`)
param_summs <- rio::import_list("small_data/param_summs.xlsx")

# load summary statistics for the 4 contrasts (created in pred_cf chunk in `urban_riffle_exp_S3.qmd`)
diff_summs <- rio::import_list("small_data/diff_summs.xlsx")

# Identify those taxa for which a difference resulting from riffle construction can be inferred
# (with 90% and 95% confidence)
more_diff_90 <- more_diff_95 <- more_sim_90 <- more_sim_95 <- vector()
for(i in 1:length(diff_summs)){
more_diff_90 <- unique(c(more_diff_90,diff_summs[[i]]$shortcode[diff_summs[[i]]$lo90 > 0]))
more_diff_95 <- unique(c(more_diff_95,diff_summs[[i]]$shortcode[diff_summs[[i]]$lo95 > 0]))
more_sim_90 <- unique(c(more_sim_90,diff_summs[[i]]$shortcode[diff_summs[[i]]$hi90 < 0]))
more_sim_95 <- unique(c(more_sim_95,diff_summs[[i]]$shortcode[diff_summs[[i]]$hi95 < 0]))
}

# Collect taxa of interest (effected by riffles or by EI) 
taxa_to_plot <- unique(c(more_diff_90,more_sim_90,
                         param_summs$b_i$shortcode[param_summs$b_i$lo90 > 0],
                         param_summs$b_i$shortcode[param_summs$b_i$hi90 < 0]))
# Prepare taxon text for figures
higher_taxa_in_plot <- higher_taxa[higher_taxa$higher_taxon %in% 
                                     unique(taxa$higher_taxon[taxa$taxoncode %in% taxa_to_plot]),]
# R results for inclusion in figure caption:
ht_string <- paste(paste0(higher_taxa_in_plot$taxon, " (", higher_taxa_in_plot$higher_taxon, ")"), collapse = "; ")
# Annelida (A); Pelecypoda (B); Coleoptera (C); Diptera (D); Ephemeroptera (E); Turbellaria (F); Gastropoda (G); Lepidoptera (L); Acarina (M); Odonata (O); Plecoptera (P); Trichoptera (T); Crustacea (Z); Cnidaria (I); Nematoda (J)
# length(taxa_to_plot) # 41 taxa to plot in @fig-coeff_plot_alt
```

`r length(unique(c(more_diff_90,more_sim_90)))` of the 113 taxa responded to riffle construction (non-zero *BA-CI* differences with 90% confidence; `r length(unique(c(more_diff_95,more_sim_95)))` with 95% confidence: @fig-coeff_plot_alt). Only two of those species were negatively associated with EI (i.e. sensitive to human disturbance; @fig-coeff_plot_alt). One of those, Hydropsychidae, filter-feeding caddis flies that build nets on rocks, increased in abundance after riffle construction, in sites with low EI, and was largely absent from sites with high EI (@fig-cf_taxon_abunds A, Table 1). The other, a chironomid, *Thiennemaniella*, decreased in abundance in sites with low EI 5-6 y after riffle construction (and were largely absent from sites with high EI before and after: @fig-cf_taxon_abunds B).

Simuliidae, with similar habitat requirements to Hydropsychidae, but more tolerant of human impacts, increased in abundance in high EI sites but not low EI sites (@fig-cf_taxon_abunds C), as did Ceratopogonidae and *Dicrotendipes* in the first year, and Glossiphonidae, *Cura pinguis*, and *Pisidium* after 5--6 y (@fig-coeff_plot_alt).

Most taxa that were positively associated with EI (i.e. tolerant of human disturbance) decreased in abundance after riffle construction in low EI sites, with declines more common after 5--6 years than in the first year (@fig-coeff_plot_alt). Nematoda, Cyclopoida, oligochaetes *Lumbriculus variegatus* (@fig-cf_taxon_abunds D, as an example), *Chaetogaster diaphanus*, Megadrili, Tubificinae groups A and B, and the chironomid *Chironomus* (@fig-cf_taxon_abunds E) decreased in abundance in low EI sites, but not high EI sites. Enchytraeidae oligochaetes decreased in both high and low EI sites.

Chironomids *Parakiefferiella* (@fig-cf_taxon_abunds F), *Polypedilum*, *Procladius* (@fig-cf_taxon_abunds G) , *Cricotopus*, and *Cryptochironomus* decreased in low EI sites over the 6 years, but increased in high EI sites in year 1 (@fig-coeff_plot_alt).

```{r}
#| label: fig-coeff_plot_alt
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 5
#| fig-cap: "Posterior distributions of the effect (b_I) of imperviousness (EI), and of differences in abundance for the four contrasts illustrating the effect of riffle construction. Each contrast estimates the change in difference between control and reference sites from before riffle construction to one of two periods after construction. The four contrasts are:ΔA1 4%, before to the first year after for sites with 4% EI; ΔA2 4%, before to the 5th/6th year after in sites for sites with 4% EI; ΔA1 32%, before to the first year after for sites with 32% EI; ΔA2 32%, before to the 5th/6th year after in sites for sites with 32% EI. For each contrast a positive trend indicates that the control and reference sites became more different, and a negative trend indicates they became more similar. For each distribution, 95th, 90th, and 75th percentiles are indicated by increasingly thick bars. Coefficients with >90% less than zero are red, and >90% greater than zero blue. Taxa are ordered by mean of b_I. Only the 41 taxa with at least one of the five distributions greater than or less than zero with >90% confidence are shown. Taxonomic affiliations are indicated parenthetically: Annelida (A); Pelecypoda (B); Coleoptera (C); Diptera (D); Ephemeroptera (E); Turbellaria (F); Gastropoda (G); Lepidoptera (L); Acarina (M); Plecoptera (P); Trichoptera (T); Crustacea (Z); Nematoda (J)."

lo <- layout(matrix(c(1:5,0,rep(6,4)),2,5,byrow = TRUE),widths = c(25,rep(10,4)),heights = c(60,2))
taxa$labs <- paste0(taxa$taxon," (", taxa$higher_taxon,")")
taxa_to_plot_df <- taxa[taxa$taxoncode %in% taxa_to_plot,]
taxa_in_order <- param_summs$b_i$shortcode[order(param_summs$b_i$mean, decreasing = FALSE)]
taxa_in_order <- taxa_in_order[taxa_in_order %in% taxa_to_plot]
taxa_to_plot_df <- taxa_to_plot_df[match(taxa_in_order, taxa_to_plot_df$taxoncode),]
miny <- 1; maxy <- length(taxa_to_plot)

  nms <- c("b_i", bquote(Delta~"A1 4% EI"), bquote(Delta~"A2 4% EI"), 
                  bquote(Delta~"A1 32% EI"), bquote(Delta~"A2 32% EI"))
for(p in 1:5){
  if(p == 1){
  summp <- param_summs[["b_i"]]
  }else{
    summp <- diff_summs[[p-1]]
  }
  summp <- summp[match(taxa_in_order,summp$shortcode),]
par(mar = c(2,ifelse(p == 1, 13, 1),1,0))
  plot(c(min(summp$lo95),max(summp$hi95)),c(miny+1,maxy-1),
       type = 'n', axes = FALSE, xlab = "",ylab = "")
for(i in miny:maxy){
  lines(c(summp$lo95[i],summp$hi95[i]),rep(miny+maxy-i,2),lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo90[i],summp$hi90[i]),rep(miny+maxy-i,2), lwd = 2,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo75[i],summp$hi75[i]),rep(miny+maxy-i,2), lwd = 4,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  points(summp$mean[i],miny+maxy-i,pch = 21, 
        bg = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
}
axis(1)
if(p == 1){
axis(2,at = (miny:maxy)[rev(taxa_to_plot_df$italic == 0)],
     labels = rev(taxa_to_plot_df$labs[taxa_to_plot_df$italic == 0]), cex.axis = 0.9, las = 1)
axis(2,at = (miny:maxy)[rev(taxa_to_plot_df$italic == 1)],
     labels = rev(taxa_to_plot_df$labs[taxa_to_plot_df$italic == 1]), 
     cex.axis = 0.9, font.axis = 3, las = 1)
}
abline(v = 0, lty = 3)
title(main = nms[p])
  }
par(mar = c(0,0,0,0))
plot.new()
title(xlab = "Coefficient", line=-1, cex.lab = 1.25)
```

```{r}
#| label: fig-cf_taxon_abunds
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Trends in abundance of 8 taxa as examples of the main trend patterns observed in taxa for which an effect of riffle was inffered with >90% confidence. The four lines in each plot connect mean (± 95% confidence intervals) metric values  before (B) and at two times after (A1, in the first year, and A2, 5-6 years later) construction of the experimental riffles for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI)."

# (Plot examples: 
example_taxa <- c("QT06","QDAF07","QD10","LO060101","QDAI04","QDAE08","QDAF03")
# 7 examples referred to in text: Hydropsychidae,  Thienemanniella, Simuliidae, 
# Oligochaete  and chironomid examples of decline in low EI (Lumbriculus and Chironomus),  
# and Parakiefferiella and Procladius from the last group

predx_cf <- expand.grid(intercept = 1, ba = factor(c(0,1,2)), ci = c(0,1), 
                        i = seq(min(u[,5]),max(u[,5]),length=10), spring = 0)
predx_cf <- data.frame(model.matrix(~ ba + ci + ba:ci + i + ba:ci:i + spring, 
                                    data = predx_cf))
predx_cf$ai <- 10^(predx_cf$i * attr(i_scaled, 'scaled:scale') + 
                attr(i_scaled, 'scaled:center')) - 0.1

# The 12 scenarios for calculating differences  
combos <- list(control_hii = which(predx_cf$ci == 0 & predx_cf$i == max(predx_cf$i)),
               impact_hii = which(predx_cf$ci == 1 & predx_cf$i == max(predx_cf$i)),
               control_lowi = which(predx_cf$ci == 0 & predx_cf$i == min(predx_cf$i)),
               impact_lowi = which(predx_cf$ci == 1 & predx_cf$i == min(predx_cf$i)))

taxa_baci <- unique(c(more_diff_90,more_sim_90))
taxa_set <- example_taxa 

# summary stats of posterior predictions for all taxa in 12 combos scenarios
# Compiled in urban_riffile_S3.qmd, chunk "pred_cf"
taxon_abun_cf_summs <- rio::import_list("small_data/taxon_abun_cf_summs.xlsx")
predx_cfs <- predx_cf[unlist(combos),]
lo <- layout(matrix(c(9,1:4,9,5:8,0,rep(10,4)),3,5,byrow = TRUE),
widths = c(1,12,10,10,10),heights = c(10,12,1))
for(i in 1:7){  #
par(mar = c(ifelse(i %in% 5:8, 4,1), ifelse(i %in% c(1,5),5,1),1,1))
cfi <- data.frame(predx_cfs, col = rep(cols,each=3),
                  xpos = rep(0:2,4),
                  x_adj = rep(c(-0.03,-0.01,0.01,0.03),each = 3),
                  pred = NA, lo = NA, hi = NA)
for( j in 1:nrow(cfi)){
  predj <- taxon_abun_cf_summs[[j]]
  cfi[j, c("pred","lo","hi")] <- predj[predj$taxoncode == taxa_set[i],
                                       c("mean","lo95","hi95")]
}

with(cfi[1:3,], plot((0:2) + cfi$x_adj[1:3], pred, type = 'b',
                                    col = cols[1], pch = 16, axes = FALSE,
                                    ylim = c(-12,8), # ylim = c(-14,5), #
                                    xlab = "", ylab = ""))
with(cfi[4:6,], lines((0:2) + cfi$x_adj[4:6], pred,
                    col = cols[2], pch = 16, type = 'b'))
with(cfi[7:9,], lines((0:2) + cfi$x_adj[7:9], pred,
                    col = cols[3], pch = 16, type = 'b'))
with(cfi[10:12,], lines((0:2) + cfi$x_adj[10:12], pred,
                    col = cols[4], pch = 16, type = 'b'))
for(j in 1:12){
lines(rep(cfi$xpos[j],2) + cfi$x_adj[j], c(cfi$lo[j],cfi$hi[j]), col = cfi$col[j])
}
if(i %in% 5:8){
  xlabs <- c("B","A1","A2")
      }else{
  xlabs <- rep(" ",3)
     }
axis(1, at = 0:2, labels = xlabs)
if(i %in% c(1,5,9)){
  ylabs <- c("","0.0001",0.001,0.01,0.1,1,10,100,1000,"10000")
      }else{
  ylabs <- rep(" ",10)
      }
axis(2, las = 1, at = log(c(0.00001,0.0001,0.001,0.01,0.1,1,10,100,1000,10000)),
labels = ylabs)
box(bty = "l")
if(taxa$italic[taxa$taxoncode == taxa_set[i]] == 1){
title(main = bquote(paste(.(LETTERS[i]), # taxa$taxoncode[taxa$taxoncode == ba0cii_taxa[i]],
   ". ", italic(.(taxa$taxon[taxa$taxoncode == taxa_set[i]])))),
adj = 0, cex.main = 1)
}else{
title(main = bquote(paste(.(LETTERS[i]), # taxa$taxoncode[taxa$taxoncode == ba0cii_taxa[i]],
   ". ", .(taxa$taxon[taxa$taxoncode == taxa_set[i]]))),
adj = 0, cex.main = 1)
}
}
par(mar = c(0,0,0,0))
plot.new()
legend("center", pch = 16, col = cols,
legend = c("Control, 32% EI", "Impact, 32% EI", "Control 4% EI","Impact 4% EI"),
cex = 1)
plot.new()
title(ylab = "Abundance per sample unit", line = -1, cex = 1.25)
plot.new()
title(xlab = "Occasion", line =2, cex = 1.25)
par(mar = c(4,4,1,1))
```

The common trend of reduced abundance of tolerant taxa following riffle construction in sites with low EI resulted in a reduction in total richness and, more weakly, abundance in those sites (@fig-assemb_diffs_dists A, E; @fig-assemb_trends A, E), driven largely by reduced QDLO richness (@fig-assemb_diffs_dists C; @fig-assemb_trends C) and abundance (@fig-assemb_diffs_dists G; @fig-assemb_trends G). Conversely, total and QDLO richness (but not abundance) increased in sites with high EI (@fig-assemb_diffs_dists C; @fig-assemb_trends C).

EPT richness did not change following riffle construction (@fig-assemb_diffs_dists B; @fig-assemb_trends B), although the increased abundance of Hydropsychidae (@fig-cf_taxon_abunds A, Table 1) in sites with low EI drove an increase in EPT abundance to increase in those sites (@fig-assemb_diffs_dists F; @fig-assemb_trends F).

Overall, the changes in abundance and richness of tolerant taxa following riffle construction did not alter the dominance of the macroinvertebrate assemblages by tolerant, cosmopolitan and invasive species (Table 1), with no change in the diversity measures Shannon's H' (@fig-assemb_diffs_dists D) or Pielou's evenness (not illustrated). We found no evidence of colonization by less tolerant species, other than a few isolated occurrences (see Discussion). As a result the low-moderate SIGNAL scores for these sites were unchanged over the study @fig-assemb_diffs_dists H; @fig-assemb_trends D).

```{r}
#| label: fig-assemb_diffs_dists
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Posterior distributions of the differences in abundance for the four contrasts illustrating the effect of riffle construction for seven assemblage metrics. A. Total richness, B. Ephemeroptera, Plecoptera and Trichoptera (EPT) richness C. Dipteran and Oligochaete (QDLO) richness, D. Shannon's H', E. total abundance, F. EPT abundance G. QDLO abundance, H. SIGNAL score. Contrasts and other conventions are as in Figure 2."

assemb_stat_summs <- readxl::read_excel("small_data/assemb_stat_diff_summs.xlsx")
# Leave out evenness, which, like SIGNAL and H, did not differ with riffle construction
assemb_stat_summs <- assemb_stat_summs[!assemb_stat_summs$stat %in% c("evenness"),]
lab_names <- c("Total richness", "EPT richness", "QDLO richness", 
               "Shannon's H'", "Total abundance", "EPT abundance", 
               "QDLO abundance","SIGNAL score")
stat_names <- c("tot_rich","ept_rich","do_rich","H","tot_n","ept_n","do_n","signal")
xlabs = c("Delta No. taxa", "Delta No. tax", "Delta No. taxa", "Delta SIGNAL",
          "Delta N", "Delta, N", "Delta N", "Delta H")
  
lo <- layout(matrix(c(1:8),2,4,byrow = TRUE),
widths = c(14,10,10,10),heights = c(10,10))
  diffs <- c("delta_baci1_hi","delta_baci2_hi","delta_baci1_low","delta_baci2_low")
nms <- c( bquote(Delta~"A2 4% EI"), bquote(Delta~"A1 4% EI"), 
          bquote(Delta~"A2 32% EI"),bquote(Delta~"A1 32% EI"))
  miny <- 0.5; maxy <- 4.5
for(j in 1:8){
  summp <- assemb_stat_summs[assemb_stat_summs$stat == stat_names[j],]
  summp <- summp[match(diffs,summp$diff),]
par(mar = c(4,ifelse(j %in% c(1,5), 5, 1),1,0))
xrange <- c(min(summp$lo95),max(summp$hi95))
  plot(xrange,c(miny,maxy),type = 'n', axes = FALSE, xlab = xlabs[j],ylab = "")
for(i in 1:4){
  lines(c(summp$lo95[i],summp$hi95[i]),rep(miny+maxy-i,2),lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo90[i],summp$hi90[i]),rep(miny+maxy-i,2), lwd = 2,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  lines(c(summp$lo75[i],summp$hi75[i]),rep(miny+maxy-i,2), lwd = 4,lend = 2,
        col = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
  points(summp$mean[i],miny+maxy-i,pch = 21, 
        bg = ifelse(summp$hi90[i] < 0,"red",ifelse(summp$lo90[i] > 0, "blue","grey")))
}
axis(1); 
if(j %in% c(1,5)){
  ylabs <- c("A2,4%EI","A1,4%EI","A2,32%EI","A1,32%EI")
}else{
    ylabs <- rep("",length=length(nms))
    }
axis(2, at = 1:4, 
     labels = ylabs, las = 1) 
box(bty = 'l')
abline(v = 0, lty = 3)
title(main = paste0(LETTERS[j],". ",lab_names[j]), adj = 0)
  }
par(mar = c(0,0,0,0))

```

```{r}
#| label: fig-assemb_trends
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 4
#| fig-cap: "Trends in assemblage metrics (A. total richness, B. Ephemeroptera, Plecoptera and Trichoptera [EPT] richness C. Dipteran and Oligochaete [QDLO] richness D. SIGNAL score, E. total abundance, F. EPT abundance, G. QDLO abundance) in a sample of 4 sample units) before and at two times after construction of the experimental riffles.  The four lines in each plot connect mean (± 95% confidence intervals) metric values over the three times for control sites and impact (i.e. site in which riffles were placed) with 4% and 32% effective imperviousness (EI)"

assemb_stat_summs <- rio::import_list("small_data/assemb_stat_summs.xlsx")
ylabs = c("Total richness", "EPT richness", "DO richness",
          "SIGNAL score", "log(total abundance)", "log(EPT abundance)","log(QDLO abundance)")
plot_index <- match(c("tot_rich","ept_rich","do_rich","signal","tot_n","ept_n","do_n"),names(assemb_stat_summs))
par(mar = c(2,4,1,1))
par(mfrow = c(2,4))
for(i in 1:7){
  ylabi <- ylabs[i]
  if(i < 5) {
    predi <- assemb_stat_summs[[plot_index[i]]]
  }else{
      predi <- log(assemb_stat_summs[[i]])
      }
cfi <- data.frame(predx_cf, 
                  pred = predi[,1], 
                  lo= predi[,2],
                  hi= predi[,3])
with(cfi[combos$control_hii,], 
     plot((0:2) + x_adjs[1], pred, ylim = c(min(cfi$lo),max(cfi$hi)), 
          type = 'b', col = cols[1], pch = 16, axes = FALSE, 
          xlab = "", ylab = ylabi))
with(cfi[combos[[2]],], lines((0:2)+ x_adjs[2], pred,
                              col = cols[2], pch = 16, type = 'b'))
with(cfi[combos[[3]],], lines((0:2) + x_adjs[3], pred,
                              col = cols[3], pch = 16, type = 'b'))
with(cfi[combos[[4]],], lines((0:2) + x_adjs[4], pred,
                              col = cols[4], pch = 16, type = 'b'))
for(k in 1:3){
  for(j in 1:4){
    cfij <- cfi[combos[[j]],]
    lines(rep(k-1,2) + x_adjs[j], c(cfij$lo[k],cfij$hi[k]), col = cols[j])
  }
}
if(i > 2){
axis(1, at = 0:2, labels = c("B","A1","A2"))
}else{
 axis(1, at = 0:2, labels = c("","",""))
  }
axis(2, las = 1); 
box(bty = "l")
title(main = paste0(LETTERS[i],"."), adj = 0)
}
par(mar = c(0,0,0,0))
plot.new()
legend("center", pch = 16, col = cols, 
       legend = c("Control, 32% EI", "Impact 32% EI","Control 4% EI", "Impact 4% EI"),
       cex =1)
```

## Discussion

### Do constructed riffles increase habitat heterogeneity?

The experimental riffles we constructed introduced a new habitat to simplified channels, thus increasing heterogeneity (i.e. the diversity of qualitatively different habitat structures) at the reach scale. The cobbles of the riffles introduced a substrate type largely absent from the reaches before riffle construction, and we demonstrated increased variability in flow, depth, and substrate size following riffle construction. While the cobble surfaces themselves were not highly complex, and thus not directly providing diverse microenvironments through their surface complexity, the alteration of reach slope, hydraulic and surface variability increased diversity of microenvironments in the study reaches.

The riffles in more urban reaches had a greater tendency to infill with sand, as evidenced by the lesser effect on median $\Phi$ in sites with higher EI (Fig 2L), suggesting catchment-scale alterations to flow and sediment regimes affect the nature of the physical changes achieved by the riffles.

### Does habitat heterogeneity alter assemblage composition?

The assemblages of all sites across the gradient of EI in our study were dominated by cosmopolitan and invasive species, although cosmopolitan infaunal taxa associated with fine sediments, such as tubificid oligochaetes and *Chironomus* [@martin_etal_2008; @berg1995], were less abundant in sites with lower EI, and became less abundant in those sites after riffle construction (Table 1, @fig-coeff_plot_alt). We identified three invasive species that were abundant in the dataset: the snails *Potamopyrgus antipodarum* [@ponder_1988] and *Physa acuta* [@zukowski_walker_2009]*,* and the Californian black worm *Lumbriculus variegatus* [@pinder_2010], and it is likely that other abundant oligochaete and chironomid taxa that we grouped because of taxonomic uncertainty include invasive species [@failla_etal_2015; @brinkhurst_gelder_1991]. *P. acuta* and *L. variegatus* were more abundant in more urban streams, while *P. antipodarum* was abundant across the urban gradient. Only *L. variegatus* declined in abundance after riffle construction, and only in less urban reaches.

The macroinvertebrate assemblages of the study reaches were thus typical of degraded urban streams. The dominance of cosmopolitan and invasive species suggest these reaches were subject to the regime of chemical and physical disturbances that arise from catchment urban stormwater runoff [@walsh_etal_2005]. Our study design did not include reference sites, which @rubin_etal_2017 suggested as an important element of robust design. However, other studies of similar streams in the study region confirm that assemblage composition in these sites differed strongly from streams of forested catchments, where diverse assemblages of sensitive macroinvertebrate taxa---rare or absent from our study sites---are the norm [@walsh_2004; @white_walsh_2020]. We argue that such catchments are appropriate references for our study sites, because among the forested catchments supporting diverse instream assemblages are comparably urban catchments to the least urban streams of our study, but with little formal urban stormwater infrastructure. For instance, Sassafras Creek has 8% TI and \<1% EI [@walsh_etal_2012] compared to 10% TI and 4% EI for the two least urban streams in this study, @fig-experiment_map, Table S1-1\], and its macroinvertebrate assemblages are dominated by sensitive taxa [@walsh_2004]. The assemblages of the most urban of our study sites remained little changed after riffle construction, remaining typical of degraded urban streams distinct from the assemblages of less impacted urban streams such as Sassafras Creek.

This conclusion of little change in assemblage composition is consistent with the lack of change in the biotic index SIGNAL (@fig-assemb_diffs_dists H), an increase in which would indicate the loss of tolerant taxa or colonization by sensitive taxa. @sundermann_etal_2011 concluded that lack of colonizers can be a limitation to post-restoration recovery. We collected one or a few individuals of several sensitive taxa that could colonize riffles (Plecoptera, the hydrobiosid *Taschorema* and Leptoceridae) in our study sites post-riffle construction, as well as a record of Hydropsychidae in a high EI stream where it did not persist. Thus, like @white_walsh_2020, who conducted a colonization experiment in some of the same streams, we conclude that the rarity of senstive taxa in the riffles is less likely a result of a lack of colonizers than of a lack of persistence under the physical and chemical disturbances of urban stormwater flows.

Similarly, diversity as measured by Shannon's H' and Pielou's evenness did not change after riffle construction (@fig-assemb_diffs_dists H). However, some changes in assemblage composition were evident, and these differed between the most urban and least urban reaches of our study. In sites with high EI, taxon richness increased by \~5 taxa per sample unit (95% CLs 1 to 10) in the first year, reducing to a more uncertain increase (95% CLs -1 to 6) after 5-6 years (@fig-assemb_diffs_dists A). Most of this increase was explained by increased abundances of dipteran and oligochaete taxa (@fig-assemb_diffs_dists C), but also glossosiphonid leeches, the bivalve *Pisidium*, and ceratopogonid biting midges, none of which were negatively associated with EI (i.e they were all tolerant of urban impacts). These increases may be explained by the increased heterogeneity afforded by fine sediments accumulating among the riffle cobbles that provided new large substrata, however the identity of the taxa that increased in abundance as urban tolerant points to ongoing limitations of urban-stormwater-driven water quality and flow disturbances.

In contrast, in sites with low EI, taxon richness decreased by \~12 (95% CLs 3-20) taxa per sample unit 5-6 years after riffle construction (after a smaller decrease in the first year, @fig-assemb_diffs_dists A). This decrease was mostly explained by a reduction in dipteran and oligochaete taxa (@fig-assemb_diffs_dists C). This decrease in abundance of tolerant, cosmopolitan taxa together with the increased abundance of a single sensitive taxon, Hydropsychidae, in low EI sites suggests a small step toward reference condition in low EI streams. Hydropsychids are net-spinning caddisflies that use rock substrates to build filter-feeding nets. Their increase in abundance in low EI sites was not accompanied by increases in other filter-feeding species: abundances of Simuliids did not change, and *Paratanytarsus/Rheotanytarsus* chironomids reduced in abundance, perhaps suggesting competitive displacement. The complexities of these responses to riffle construction underlying the reduction in taxon richness underline the limitations of richness and diversity metrics as indicators of success [@rubin_etal_2017].

Nevertheless, the reduction in abundances of cosmopolitan species and increased abundance of sensitive species in low EI sites can be interpreted as a small improvement in diversity. This small improvement and the absence of improvement in high EI sites is consistent with the conclusion of @miller_etal_2010 of reduced response in more urban sites. But the smallness of the response in our lowest EI sites, with 4% EI, confirms that even a very small degree of catchment stormwater impacts can limit instream community assembly [@walsh_webb_2016; @king_baker_2011]. Larger responses to restoration of instream habitat heterogeneity are only likely to be achieved in streams without urban impacts, or with high-performing urban stormwater control measures that intercept runoff from near-all upstream impervious surfaces [e.g. @walsh_etal_2022].

### Setting expectations and priorities for urban stream management

While macroinvertebrate assemblage composition might be considered of interest primarily to ecologists as a measure of restoration success [@scoggins_etal_2022], communication of what macroinvertebrate assemblage composition tells us can be a potent tool in informing public desire for stream restoration. Our focus on taxonomic identity in this study, to interpret responses of assemblage metrics, provides a clear picture that the state of streams in urban catchments is a long way from what they could be with alternative catchment practices. It shows that provision of greater habitat heterogeneity in degraded urban streams will primarily provide habitat for cosmopolitan, invasive species that can tolerate flashy, polluted flows of urban stormwater. It suggests a redirection of priorities in two primary directions. First, in-stream works should be targeted to catchments without larger-scale limitations such as urban or agricultural impacts [@miller_etal_2010]. Second, in urban catchments, management of catchment processes should be a priority to provide water quality and flow regimes to streams that a) reduce the risk of heterogeneous habitat being swamped by stormwater flows [@larson_etal_2001; @white_walsh_2020], and b) can provide habitat quality and flow disturbance frequency that permit sensitive colonising species to persist.

There is growing evidence that effective catchment urban stormwater control can reduce water quality and flow impacts to levels at which sensitive in-stream biota can be supported. The primary evidence comes from streams that have at least in part been protected from catchment urbanization by informal stormwater drainage [@walsh_2004] or by extensive dispersed stormwater control [@hopkins_etal_2022]. We are not aware of robust studies that have demonstrated restoration of biotic assemblages through catchment stormwater control, but restoration of water quality and hydrology after stormwater retrofit brings hope [@walsh_etal_2022]. However, that study cautioned that retrofitting existing stormwater drainage systems to provide adequate retention, treatment and loss of stormwater runoff to achieve instream response is challenging. In existing urban landscapes, the availability of appropriately located land for stormwater control measures and the lack of demand for stormwater harvesting to reduce runoff volumes remain challenging problems in most existing policy settings.

Nevertheless, the appetite for restoring urban stream corridors is likely to continue and grow [@scoggins_etal_2022]. We are not suggesting that projects aiming to provide amenity, recreation, and biodiversity in urban floodplains are without merit. But often such projects are described as urban stream restoration, and include channel reconfiguration as part of works. We hope that our study will help to moderate expectations of the in-stream changes that can be achieved without addressing larger catchment-scale limitations.

## Acknowledgements

This study was funded by the CRC for Freshwater Ecology and Melbourne Water. We thank Graham Rooney and Scott Seymour for arranging funding for the works; Neil Craigie who designed and supervised riffle construction; Sharyn Rossrakesh for conducting the reach surveys; and the team who assisted with field collections and lab processing: Jim Longworth, Elaine Bayes, Jason Sonneman, Andrew Sharpe, Claire Sellens, Sue Witteveen, Melissa Aalbers, Rhys Coleman, John Gooderham, Jessica Miller, Edward Tsyrlin, and Kristy Brooke. During the writing of this paper, CJW was funded by the Melbourne Water Research-Practice Partnership between Melbourne Water and the University of Melbourne.

## References
